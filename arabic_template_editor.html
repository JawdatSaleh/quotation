<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محرر القوالب - منصة الفواتير الاحترافية</title>
    
    <!-- External Dependencies -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800;900&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <!-- Quill Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1e40af;
            --primary-dark: #1e3a8a;
            --secondary: #0891b2;
            --success: #059669;
            --danger: #dc2626;
            --warning: #d97706;
            --info: #0284c7;
            --dark: #0f172a;
            --light: #f8fafc;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        body {
            font-family: 'Cairo', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-100);
            color: var(--dark);
            overflow: hidden;
            direction: rtl;
        }

        /* شريط الأدوات */
        .editor-toolbar {
            height: 65px;
            background: white;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            position: fixed;
            top: 0;
            right: 0;
            left: 0;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
        }

        .toolbar-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .toolbar-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toolbar-title input {
            font-size: 18px;
            font-weight: 600;
            border: none;
            background: transparent;
            padding: 10px 14px;
            border-radius: 8px;
            transition: all 0.2s;
            font-family: 'Cairo', sans-serif;
            width: 300px;
        }

        .template-category-select {
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 14px;
            font-family: 'Cairo', sans-serif;
            background: white;
            cursor: pointer;
            min-width: 170px;
        }

        .template-category-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        .toolbar-title input:hover {
            background: var(--gray-100);
        }

        .toolbar-title input:focus {
            outline: none;
            background: var(--gray-100);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        .toolbar-actions {
            display: flex;
            gap: 10px;
        }

        .toolbar-btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: 'Cairo', sans-serif;
        }

        .toolbar-btn.primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 2px 8px rgba(30, 64, 175, 0.3);
        }

        .toolbar-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 64, 175, 0.4);
        }

        .toolbar-btn.secondary {
            background: white;
            color: var(--gray-700);
            border: 2px solid var(--gray-300);
        }

        .toolbar-btn.secondary:hover {
            background: var(--gray-100);
            border-color: var(--primary);
            color: var(--primary);
        }

        /* منطقة المحرر الرئيسية */
        .editor-main {
            display: flex;
            flex: 1;
            margin-top: 65px;
            height: calc(100vh - 65px);
        }

        /* لوحة المكونات */
        .components-panel {
            width: 300px;
            background: white;
            border-left: 1px solid var(--gray-200);
            overflow-y: auto;
            padding: 24px;
            position: sticky;
            top: 65px;
            height: calc(100vh - 65px);
        }

        .panel-title {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--gray-500);
            margin-bottom: 18px;
            letter-spacing: 0.5px;
        }

        .component-category {
            margin-bottom: 28px;
        }

        .component-item {
            background: linear-gradient(135deg, var(--gray-50), var(--gray-100));
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            cursor: move;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            overflow: hidden;
        }

        .component-item::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--primary), var(--secondary));
            transform: translateX(100%);
            transition: transform 0.3s;
        }

        .component-item:hover {
            border-color: var(--primary);
            transform: translateX(-4px);
            box-shadow: 0 4px 12px rgba(30, 64, 175, 0.15);
        }

        .component-item:hover::before {
            transform: translateX(0);
        }

        .component-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .component-icon {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 18px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .component-info {
            flex: 1;
        }

        .component-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 2px;
        }

        .component-desc {
            font-size: 12px;
            color: var(--gray-500);
        }

        /* منطقة اللوحة */
        .editor-canvas {
            flex: 1;
            background: var(--gray-100);
            overflow-y: auto;
            padding: 40px;
            position: relative;
        }

        .canvas-wrapper {
            max-width: 900px;
            margin: 0 auto;
        }

        .document-preview {
            background: white;
            min-height: 1188px; /* A4 نسبة */
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
            border-radius: 12px;
            padding: 60px;
            position: relative;
            margin: 0 auto 40px auto;
        }

        /* مناطق الإسقاط */
        .drop-zone {
            min-height: 100px;
            border: 3px dashed var(--gray-300);
            border-radius: 12px;
            margin: 20px 0;
            padding: 30px;
            text-align: center;
            color: var(--gray-400);
            transition: all 0.3s;
            position: relative;
            background: var(--gray-50);
        }

        .drop-zone.drag-over {
            background: linear-gradient(135deg, rgba(30, 64, 175, 0.05), rgba(8, 145, 178, 0.05));
            border-color: var(--primary);
            transform: scale(1.02);
        }

        .drop-zone-placeholder {
            font-size: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: 500;
        }

        .drop-zone-placeholder i {
            font-size: 24px;
            color: var(--primary);
        }

        /* أقسام القالب */
        .template-section {
            margin-bottom: 28px;
            padding: 24px;
            background: linear-gradient(135deg, var(--gray-50), white);
            border-radius: 12px;
            position: relative;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .template-section:hover {
            border-color: var(--primary);
            box-shadow: 0 8px 24px rgba(30, 64, 175, 0.12);
            transform: translateY(-2px);
        }

        .section-controls {
            position: absolute;
            top: 12px;
            left: 12px;
            display: flex;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .template-section:hover .section-controls {
            opacity: 1;
        }

        .section-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-600);
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .section-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }

        /* قسم الرأس */
        .header-section {
            display: flex;
            align-items: center;
            gap: 35px;
            padding-bottom: 25px;
            border-bottom: 3px solid var(--gray-200);
            margin-bottom: 35px;
        }

        .company-logo {
            width: 130px;
            height: 130px;
            background: linear-gradient(135deg, var(--gray-200), var(--gray-300));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-400);
            font-size: 48px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .company-logo::before {
            content: 'انقر للرفع';
            position: absolute;
            bottom: 8px;
            font-size: 11px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .company-logo:hover {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .company-logo:hover::before {
            opacity: 1;
        }

        .company-info {
            flex: 1;
        }

        .company-name {
            font-size: 32px;
            font-weight: 800;
            color: var(--gray-900);
            margin-bottom: 10px;
        }

        .company-details {
            color: var(--gray-600);
            line-height: 1.8;
            font-size: 15px;
        }

        /* جدول الأسعار */
        .pricing-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 24px 0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .pricing-table th {
            background: linear-gradient(135deg, var(--gray-100), var(--gray-200));
            padding: 14px;
            text-align: right;
            font-weight: 600;
            font-size: 14px;
            color: var(--gray-700);
            border-bottom: 2px solid var(--gray-300);
        }

        .pricing-table td {
            padding: 14px;
            border-bottom: 1px solid var(--gray-200);
            font-size: 14px;
            background: white;
        }

        .pricing-table tr:last-child td {
            border-bottom: none;
        }

        .pricing-table input {
            width: 100%;
            border: none;
            background: transparent;
            padding: 6px;
            font-family: 'Cairo', sans-serif;
            font-size: 14px;
        }

        .pricing-table input:focus {
            outline: none;
            background: var(--gray-50);
            border-radius: 4px;
        }

        .add-row-btn {
            width: 100%;
            padding: 12px;
            border: 2px dashed var(--gray-300);
            background: transparent;
            border-radius: 8px;
            color: var(--gray-500);
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
        }

        .add-row-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(30, 64, 175, 0.05);
        }

        /* لوحة الخصائص */
        .properties-panel {
            width: 340px;
            background: white;
            border-right: 1px solid var(--gray-200);
            overflow-y: auto;
            padding: 24px;
            position: sticky;
            top: 65px;
            height: calc(100vh - 65px);
        }

        .property-group {
            margin-bottom: 28px;
        }

        .property-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 8px;
        }

        .property-input {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid var(--gray-300);
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Cairo', sans-serif;
            transition: all 0.2s;
        }

        .property-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        .color-picker-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .color-picker {
            width: 45px;
            height: 45px;
            border: 2px solid var(--gray-300);
            border-radius: 8px;
            cursor: pointer;
        }

        .color-value {
            flex: 1;
        }

        /* التوافق مع الجوال */
        @media (max-width: 1024px) {
            .components-panel {
                display: none;
            }

            .properties-panel {
                position: fixed;
                left: -340px;
                top: 65px;
                height: calc(100vh - 65px);
                transition: left 0.3s;
                z-index: 999;
                box-shadow: 4px 0 6px -1px rgb(0 0 0 / 0.1);
            }

            .properties-panel.active {
                left: 0;
            }
        }

        @media (max-width: 768px) {
            .editor-canvas {
                padding: 20px;
            }

            .document-preview {
                padding: 30px;
            }

            .toolbar-title input {
                font-size: 16px;
                max-width: 150px;
            }
        }

        /* محرر النص الغني */
        .text-editor {
            min-height: 120px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            background: white;
        }

        .ql-toolbar {
            border-top-right-radius: 8px;
            border-top-left-radius: 8px;
            direction: rtl;
        }

        .ql-container {
            border-bottom-right-radius: 8px;
            border-bottom-left-radius: 8px;
            font-family: 'Cairo', sans-serif;
            direction: rtl;
        }

        .ql-editor {
            direction: rtl;
            text-align: right;
        }

        /* حالة التحميل */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid white;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* تخصيص شريط التمرير */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--gray-100);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gray-400);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* طباعة ومعاينة احترافية */
        @media print {
            body {
                background: white !important;
                overflow: visible !important;
            }

            .editor-toolbar,
            .components-panel,
            .properties-panel,
            .drop-zone,
            .section-controls,
            .add-row-btn {
                display: none !important;
            }

            .editor-main {
                margin: 0;
                height: auto;
            }

            .document-preview {
                box-shadow: none;
                border-radius: 0;
                margin: 0;
                width: 100%;
                padding: 40px;
                min-height: auto;
            }
        }
    </style>
</head>
<body>
    <!-- شريط الأدوات -->
    <div class="editor-toolbar">
        <div class="toolbar-right">
            <button class="toolbar-btn secondary" onclick="goBack()">
                <i class="fas fa-arrow-right"></i>
                رجوع
            </button>
            <div class="toolbar-title">
                <input type="text" value="قالب عرض سعر البناء" id="templateName">
                <select id="templateCategory" class="template-category-select">
                    <option value="quotation" selected>عرض سعر</option>
                    <option value="invoice">فاتورة</option>
                    <option value="proposal">مقترح</option>
                    <option value="contract">عقد</option>
                </select>
            </div>
        </div>
        <div class="toolbar-actions">
            <button class="toolbar-btn secondary" onclick="previewTemplate()">
                <i class="fas fa-eye"></i>
                معاينة
            </button>
            <button class="toolbar-btn secondary" onclick="printTemplate()">
                <i class="fas fa-print"></i>
                طباعة
            </button>
            <button class="toolbar-btn secondary" onclick="saveAsDraft()">
                <i class="fas fa-save"></i>
                حفظ كمسودة
            </button>
            <button class="toolbar-btn primary" onclick="publishTemplate()">
                <i class="fas fa-check"></i>
                حفظ ونشر
            </button>
        </div>
    </div>

    <!-- منطقة المحرر الرئيسية -->
    <div class="editor-main">
        <!-- لوحة المكونات -->
        <div class="components-panel">
            <div class="panel-title">المكونات الأساسية</div>
            
            <!-- المكونات الأساسية -->
            <div class="component-category">
                <div class="component-item" draggable="true" data-component="header">
                    <div class="component-icon">
                        <i class="fas fa-heading"></i>
                    </div>
                    <div class="component-info">
                        <div class="component-name">رأس الصفحة</div>
                        <div class="component-desc">معلومات الشركة والشعار</div>
                    </div>
                </div>

                <div class="component-item" draggable="true" data-component="client">
                    <div class="component-icon">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="component-info">
                        <div class="component-name">بيانات العميل</div>
                        <div class="component-desc">معلومات العميل</div>
                    </div>
                </div>

                <div class="component-item" draggable="true" data-component="text">
                    <div class="component-icon">
                        <i class="fas fa-paragraph"></i>
                    </div>
                    <div class="component-info">
                        <div class="component-name">نص حر</div>
                        <div class="component-desc">محتوى نصي منسق</div>
                    </div>
                </div>

                <div class="component-item" draggable="true" data-component="table">
                    <div class="component-icon">
                        <i class="fas fa-table"></i>
                    </div>
                    <div class="component-info">
                        <div class="component-name">جدول الأسعار</div>
                        <div class="component-desc">البنود والأسعار</div>
                    </div>
                </div>

                <div class="component-item" draggable="true" data-component="terms">
                    <div class="component-icon">
                        <i class="fas fa-list"></i>
                    </div>
                    <div class="component-info">
                        <div class="component-name">الشروط والأحكام</div>
                        <div class="component-desc">البنود القانونية</div>
                    </div>
                </div>

                <div class="component-item" draggable="true" data-component="signature">
                    <div class="component-icon">
                        <i class="fas fa-signature"></i>
                    </div>
                    <div class="component-info">
                        <div class="component-name">التوقيع</div>
                        <div class="component-desc">مكان التوقيع</div>
                    </div>
                </div>
            </div>

            <!-- المكونات المتقدمة -->
            <div class="panel-title">المكونات المتقدمة</div>
            <div class="component-category">
                <div class="component-item" draggable="true" data-component="timeline">
                    <div class="component-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="component-info">
                        <div class="component-name">الجدول الزمني</div>
                        <div class="component-desc">مراحل المشروع</div>
                    </div>
                </div>

                <div class="component-item" draggable="true" data-component="gallery">
                    <div class="component-icon">
                        <i class="fas fa-images"></i>
                    </div>
                    <div class="component-info">
                        <div class="component-name">معرض الصور</div>
                        <div class="component-desc">صور المنتجات</div>
                    </div>
                </div>

                <div class="component-item" draggable="true" data-component="payment">
                    <div class="component-icon">
                        <i class="fas fa-credit-card"></i>
                    </div>
                    <div class="component-info">
                        <div class="component-name">جدول الدفعات</div>
                        <div class="component-desc">خطة السداد</div>
                    </div>
                </div>

                <div class="component-item" draggable="true" data-component="qr">
                    <div class="component-icon">
                        <i class="fas fa-qrcode"></i>
                    </div>
                    <div class="component-info">
                        <div class="component-name">رمز QR</div>
                        <div class="component-desc">رمز سريع للدفع</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- منطقة اللوحة -->
        <div class="editor-canvas">
            <div class="canvas-wrapper">
                <div class="document-preview" id="documentCanvas">
                    <!-- منطقة الإسقاط الأولية -->
                    <div class="drop-zone" data-position="0">
                        <div class="drop-zone-placeholder">
                            <i class="fas fa-plus-circle"></i>
                            <span>اسحب المكونات هنا لبدء البناء</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- لوحة الخصائص -->
        <div class="properties-panel" id="propertiesPanel">
            <div class="panel-title">خصائص القالب</div>
            
            <div class="property-group">
                <label class="property-label">لون الخلفية</label>
                <div class="color-picker-group">
                    <input type="color" class="color-picker" value="#ffffff" id="bgColor">
                    <input type="text" class="property-input color-value" value="#ffffff">
                </div>
            </div>

            <div class="property-group">
                <label class="property-label">اللون الرئيسي</label>
                <div class="color-picker-group">
                    <input type="color" class="color-picker" value="#1e40af" id="primaryColor">
                    <input type="text" class="property-input color-value" value="#1e40af">
                </div>
            </div>

            <div class="property-group">
                <label class="property-label">نوع الخط</label>
                <select class="property-input" id="fontFamily">
                    <option value="Cairo">Cairo</option>
                    <option value="Amiri">Amiri</option>
                    <option value="Tajawal">Tajawal</option>
                    <option value="Almarai">Almarai</option>
                    <option value="Noto Kufi Arabic">Noto Kufi Arabic</option>
                </select>
            </div>

            <div class="property-group">
                <label class="property-label">حجم الخط</label>
                <select class="property-input" id="fontSize">
                    <option value="12px">12px</option>
                    <option value="14px" selected>14px</option>
                    <option value="16px">16px</option>
                    <option value="18px">18px</option>
                </select>
            </div>

            <div class="property-group">
                <label class="property-label">ارتفاع السطر</label>
                <select class="property-input" id="lineHeight">
                    <option value="1.4">1.4</option>
                    <option value="1.6">1.6</option>
                    <option value="1.8" selected>1.8</option>
                    <option value="2.0">2.0</option>
                </select>
            </div>

            <div class="panel-title" style="margin-top: 35px;">إعدادات الصفحة</div>

            <div class="property-group">
                <label class="property-label">حجم الصفحة</label>
                <select class="property-input" id="pageSize">
                    <option value="A4">A4</option>
                    <option value="Letter">Letter</option>
                    <option value="Legal">Legal</option>
                </select>
            </div>

            <div class="property-group">
                <label class="property-label">اتجاه الصفحة</label>
                <select class="property-input" id="pageOrientation">
                    <option value="عمودي">عمودي</option>
                    <option value="أفقي">أفقي</option>
                </select>
            </div>

            <div class="property-group">
                <label class="property-label">الهوامش</label>
                <input type="text" class="property-input" value="60px" id="pageMargin">
            </div>

            <div class="panel-title" style="margin-top: 35px;">الضريبة والعملة</div>

            <div class="property-group">
                <label class="property-label">نسبة الضريبة</label>
                <input type="number" class="property-input" value="15" min="0" max="100" id="vatRate">
            </div>

            <div class="property-group">
                <label class="property-label">العملة</label>
                <select class="property-input" id="currency">
                    <option value="SAR">ريال سعودي (SAR)</option>
                    <option value="USD">دولار أمريكي (USD)</option>
                    <option value="EUR">يورو (EUR)</option>
                    <option value="AED">درهم إماراتي (AED)</option>
                    <option value="EGP">جنيه مصري (EGP)</option>
                </select>
            </div>
        </div>
    </div>

    <!-- طبقة التحميل -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        // إدارة الحالة
        const TEMPLATE_STORAGE_KEY = 'customTemplates';
        const TEMPLATE_API_ENDPOINT = '/api/templates';
        const DEMO_TOKEN_PREFIX = 'demo-token-';
        let draggedElement = null;
        let currentTemplate = {
            id: null,
            serverId: null,
            source: 'custom',
            baseTemplateId: null,
            name: 'قالب عرض سعر البناء',
            category: 'quotation',
            sections: [],
            settings: {
                bgColor: '#ffffff',
                primaryColor: '#1e40af',
                fontFamily: 'Cairo',
                fontSize: '14px',
                lineHeight: '1.8',
                pageSize: 'A4',
                pageOrientation: 'عمودي',
                pageMargin: '60px',
                vat: 15,
                currency: 'SAR'
            }
        };
        let returnPage = 'templates';
        let initialMessageDisplayed = false;

        // التهيئة
        document.addEventListener('DOMContentLoaded', async () => {
            await hydrateTemplateFromQuery();
            initializeDragDrop();
            initializeColorPickers();
            initializePropertyControls();
            applyTemplateSettings();
            if (!initialMessageDisplayed) {
                showNotification('مرحباً! ابدأ بسحب المكونات إلى اللوحة', 'info');
                initialMessageDisplayed = true;
            }
        });

        function getAuthToken() {
            try {
                const token = localStorage.getItem('token');
                if (!token || token.startsWith(DEMO_TOKEN_PREFIX)) {
                    return null;
                }
                return token;
            } catch (error) {
                console.warn('Auth token unavailable:', error);
                return null;
            }
        }

        function canUseServerStorage() {
            return Boolean(getAuthToken());
        }

        function getAuthorizedHeaders() {
            const token = getAuthToken();
            if (!token) {
                return null;
            }
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        async function fetchTemplateFromServer(templateId) {
            const headers = getAuthorizedHeaders();
            if (!headers) {
                return null;
            }
            const response = await fetch(`${TEMPLATE_API_ENDPOINT}/${templateId}`, { headers });
            if (!response.ok) {
                throw new Error('Server template request failed');
            }
            const data = await response.json();
            if (!data?.template) {
                return null;
            }
            return normalizeServerTemplate(data.template);
        }

        async function saveTemplateToServer(payload) {
            const headers = getAuthorizedHeaders();
            if (!headers) {
                return null;
            }
            const method = currentTemplate.serverId ? 'PUT' : 'POST';
            const endpoint = currentTemplate.serverId
                ? `${TEMPLATE_API_ENDPOINT}/${currentTemplate.serverId}`
                : TEMPLATE_API_ENDPOINT;
            const response = await fetch(endpoint, {
                method,
                headers,
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorPayload = await response.json().catch(() => ({}));
                throw new Error(errorPayload?.error || 'Failed to save template');
            }
            const data = await response.json();
            return data?.template ? normalizeServerTemplate(data.template) : null;
        }

        function normalizeServerTemplate(template) {
            if (!template) return null;
            const friendlyTitle = template.name || template.title || 'قالب بدون اسم';
            return {
                id: template._id || template.id,
                title: friendlyTitle,
                category: template.type || template.category || 'quotation',
                status: template.status || 'draft',
                description: template.description || (template.updatedAt ? `آخر تحديث: ${formatArDateTime(new Date(template.updatedAt))}` : 'قالب محفوظ على الخادم'),
                updatedAt: template.updatedAt || new Date().toISOString(),
                html: template.html || '',
                settings: template.settings || {},
                tags: Array.isArray(template.tags) ? template.tags : [],
                source: 'server'
            };
        }

        function updateLocalTemplateCache(templateData) {
            const templates = loadSavedTemplates();
            const existingIndex = templates.findIndex(template => template.id === templateData.id);
            if (existingIndex > -1) {
                templates[existingIndex] = templateData;
            } else {
                templates.push(templateData);
            }

            if (typeof localStorage === 'undefined') {
                return;
            }
            try {
                localStorage.setItem(TEMPLATE_STORAGE_KEY, JSON.stringify(templates));
            } catch (error) {
                console.warn('تعذر تحديث القوالب المخزنة محلياً:', error);
            }
        }

        async function hydrateTemplateFromQuery() {
            const params = new URLSearchParams(window.location.search);
            returnPage = params.get('return') || 'templates';
            currentTemplate.source = params.get('source') || 'custom';
            currentTemplate.baseTemplateId = params.get('templateId') || null;

            const providedTitle = params.get('title');
            const providedCategory = params.get('category');
            const mode = params.get('mode') || 'edit';

            const templateNameInput = document.getElementById('templateName');
            if (providedTitle && templateNameInput) {
                templateNameInput.value = providedTitle;
                currentTemplate.name = providedTitle;
            }

            const categorySelect = document.getElementById('templateCategory');
            if (categorySelect) {
                categorySelect.value = providedCategory || categorySelect.value;
                currentTemplate.category = categorySelect.value;
            }

            if (currentTemplate.source === 'custom' && currentTemplate.baseTemplateId) {
                currentTemplate.id = currentTemplate.baseTemplateId;
            } else {
                currentTemplate.id = currentTemplate.id || `custom-${Date.now()}`;
            }

            const shouldLoadFromServer = currentTemplate.source === 'server' && currentTemplate.baseTemplateId;
            const shouldLoadFromLocal = currentTemplate.source === 'custom' && currentTemplate.baseTemplateId;

            if (shouldLoadFromServer) {
                try {
                    showLoading();
                    const savedTemplate = await fetchTemplateFromServer(currentTemplate.baseTemplateId);
                    if (savedTemplate) {
                        applyTemplateFromStorage(savedTemplate);
                        currentTemplate.serverId = savedTemplate.id;
                        initialMessageDisplayed = true;
                        showNotification('تم تحميل القالب من الخادم للتعديل', 'success');
                        return;
                    }
                } catch (error) {
                    console.error('فشل تحميل القالب من الخادم:', error);
                    showNotification('تعذر تحميل القالب من الخادم، سيتم إنشاء قالب جديد', 'error');
                } finally {
                    hideLoading();
                }
            }

            if (shouldLoadFromLocal) {
                const savedTemplate = getTemplateFromStorage(currentTemplate.baseTemplateId);
                if (savedTemplate) {
                    applyTemplateFromStorage(savedTemplate);
                    initialMessageDisplayed = true;
                    showNotification('تم تحميل القالب المحفوظ للتعديل', 'success');
                    return;
                }
            }

            if (mode === 'create' && !initialMessageDisplayed) {
                showNotification('ابدأ في إنشاء قالبك الجديد عبر سحب المكونات إلى اللوحة', 'info');
                initialMessageDisplayed = true;
            }
        }

        function loadSavedTemplates() {
            if (typeof localStorage === 'undefined') {
                return [];
            }
            try {
                const stored = localStorage.getItem(TEMPLATE_STORAGE_KEY);
                return stored ? JSON.parse(stored) : [];
            } catch (error) {
                console.warn('تعذر قراءة القوالب المحفوظة:', error);
                return [];
            }
        }

        function getTemplateFromStorage(templateId) {
            if (!templateId) return null;
            return loadSavedTemplates().find(template => template.id === templateId) || null;
        }

        function applyTemplateFromStorage(template) {
            const canvas = document.getElementById('documentCanvas');
            if (!canvas) return;
            canvas.innerHTML = template.html || canvas.innerHTML;

            currentTemplate.id = template.id;
            currentTemplate.serverId = template.source === 'server' ? template.id : null;
            currentTemplate.name = template.title || template.name || currentTemplate.name;
            currentTemplate.category = template.category || currentTemplate.category;
            currentTemplate.status = template.status || currentTemplate.status;
            currentTemplate.tags = template.tags || currentTemplate.tags;

            const templateNameInput = document.getElementById('templateName');
            if (templateNameInput && (template.title || template.name)) {
                templateNameInput.value = template.title || template.name;
            }

            const categorySelect = document.getElementById('templateCategory');
            if (categorySelect && template.category) {
                categorySelect.value = template.category;
            }

            if (template.settings) {
                currentTemplate.settings = {
                    ...currentTemplate.settings,
                    ...template.settings
                };
                applyStoredSettingsToInputs(template.settings);
                if (template.settings.bgColor) {
                    const bgColorInput = document.getElementById('bgColor');
                    if (bgColorInput) {
                        bgColorInput.value = template.settings.bgColor;
                        if (bgColorInput.nextElementSibling) {
                            bgColorInput.nextElementSibling.value = template.settings.bgColor;
                        }
                    }
                }
                if (template.settings.primaryColor) {
                    const primaryColorInput = document.getElementById('primaryColor');
                    if (primaryColorInput) {
                        primaryColorInput.value = template.settings.primaryColor;
                        if (primaryColorInput.nextElementSibling) {
                            primaryColorInput.nextElementSibling.value = template.settings.primaryColor;
                        }
                    }
                }
            }

            updateDropZones();
            initializeEditors();
            applyTemplateSettings();
        }

        // السحب والإفلات
        function initializeDragDrop() {
            // عناصر المكونات
            document.querySelectorAll('.component-item').forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
            });

            // تحديث مناطق الإسقاط
            updateDropZones();
        }

        function handleDragStart(e) {
            draggedElement = e.target.closest('.component-item');
            draggedElement.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('component', draggedElement.dataset.component);
        }

        function handleDragEnd(e) {
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
                draggedElement = null;
            }
        }

        function updateDropZones() {
            const canvas = document.getElementById('documentCanvas');
            if (!canvas) return;

            let dropZones = canvas.querySelectorAll('.drop-zone');
            if (!dropZones.length) {
                const newPosition = canvas.querySelectorAll('.template-section').length;
                canvas.insertAdjacentHTML('beforeend', createDropZone(newPosition));
                dropZones = canvas.querySelectorAll('.drop-zone');
            }

            dropZones.forEach(zone => {
                zone.removeEventListener('dragover', handleDragOver);
                zone.removeEventListener('drop', handleDrop);
                zone.removeEventListener('dragleave', handleDragLeave);
                zone.addEventListener('dragover', handleDragOver);
                zone.addEventListener('drop', handleDrop);
                zone.addEventListener('dragleave', handleDragLeave);
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            const componentType = e.dataTransfer.getData('component');
            const position = parseInt(e.currentTarget.dataset.position, 10) || 0;
            
            addComponent(componentType, position);
        }

        // إنشاء المكونات
        function addComponent(type, position) {
            const canvas = document.getElementById('documentCanvas');
            let componentHTML = '';
            
            switch(type) {
                case 'header':
                    componentHTML = createHeaderComponent();
                    break;
                case 'client':
                    componentHTML = createClientComponent();
                    break;
                case 'text':
                    componentHTML = createTextComponent();
                    break;
                case 'table':
                    componentHTML = createTableComponent();
                    break;
                case 'terms':
                    componentHTML = createTermsComponent();
                    break;
                case 'signature':
                    componentHTML = createSignatureComponent();
                    break;
                case 'timeline':
                    componentHTML = createTimelineComponent();
                    break;
                case 'gallery':
                    componentHTML = createGalleryComponent();
                    break;
                case 'payment':
                    componentHTML = createPaymentComponent();
                    break;
                case 'qr':
                    componentHTML = createQRComponent();
                    break;
            }
            
            // إدراج المكون
            const dropZone = canvas.querySelector(`.drop-zone[data-position="${position}"]`);
            dropZone.outerHTML = componentHTML + createDropZone(position + 1);
            
            // إعادة التهيئة
            updateDropZones();
            initializeEditors();
            showNotification('تم إضافة المكون بنجاح', 'success');

            if (type === 'table') {
                updateCalculations();
            }
        }

        // قوالب المكونات
        function createHeaderComponent() {
            return `
                <div class="template-section" data-type="header">
                    <div class="section-controls">
                        <button class="section-btn" onclick="moveUp(this)" title="نقل للأعلى">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="section-btn" onclick="moveDown(this)" title="نقل للأسفل">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button class="section-btn" onclick="editSection(this)" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="section-btn" onclick="deleteSection(this)" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="header-section">
                        <div class="company-logo" onclick="uploadLogo()">
                            <i class="fas fa-building"></i>
                        </div>
                        <div class="company-info">
                            <div class="company-name" contenteditable="true">اسم شركتك</div>
                            <div class="company-details" contenteditable="true">
                                العنوان: شارع الملك فهد، الرياض 12345<br>
                                الهاتف: 0500000000 | البريد: info@company.sa<br>
                                الموقع: www.company.sa | السجل التجاري: 1234567890
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function createClientComponent() {
            return `
                <div class="template-section" data-type="client">
                    <div class="section-controls">
                        <button class="section-btn" onclick="moveUp(this)" title="نقل للأعلى">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="section-btn" onclick="moveDown(this)" title="نقل للأسفل">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button class="section-btn" onclick="editSection(this)" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="section-btn" onclick="deleteSection(this)" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 35px;">
                        <div>
                            <h3 style="margin-bottom: 14px; color: var(--gray-700); font-size: 18px;">بيانات العميل</h3>
                            <div contenteditable="true" style="line-height: 2; color: var(--gray-600); font-size: 15px;">
                                السيد/ [اسم العميل]<br>
                                الشركة: [اسم الشركة]<br>
                                العنوان: [العنوان]<br>
                                الجوال: [رقم الجوال]<br>
                                البريد: [البريد الإلكتروني]
                            </div>
                        </div>
                        <div>
                            <h3 style="margin-bottom: 14px; color: var(--gray-700); font-size: 18px;">تفاصيل العرض</h3>
                            <div contenteditable="true" style="line-height: 2; color: var(--gray-600); font-size: 15px;">
                                رقم العرض: QUO-2025-001<br>
                                التاريخ: ${new Date().toLocaleDateString('ar-SA')}<br>
                                صالح حتى: ${new Date(Date.now() + 30*24*60*60*1000).toLocaleDateString('ar-SA')}<br>
                                المشروع: [اسم المشروع]<br>
                                المعد: [اسم الموظف]
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function createTextComponent() {
            const id = 'editor-' + Date.now();
            return `
                <div class="template-section" data-type="text">
                    <div class="section-controls">
                        <button class="section-btn" onclick="moveUp(this)" title="نقل للأعلى">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="section-btn" onclick="moveDown(this)" title="نقل للأسفل">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button class="section-btn" onclick="editSection(this)" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="section-btn" onclick="deleteSection(this)" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div id="${id}" class="text-editor">
                        <p>السادة/ [اسم العميل] المحترمين</p>
                        <p>تحية طيبة وبعد،</p>
                        <p>يسرنا أن نتقدم لسيادتكم بعرض السعر الخاص بمشروع [اسم المشروع]، وفقاً للمواصفات المطلوبة.</p>
                    </div>
                </div>
            `;
        }

        function createTableComponent() {
            return `
                <div class="template-section" data-type="table">
                    <div class="section-controls">
                        <button class="section-btn" onclick="moveUp(this)" title="نقل للأعلى">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="section-btn" onclick="moveDown(this)" title="نقل للأسفل">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button class="section-btn" onclick="editSection(this)" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="section-btn" onclick="deleteSection(this)" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <h3 style="margin-bottom: 18px; font-size: 20px;">بنود العرض</h3>
                    <table class="pricing-table">
                        <thead>
                            <tr>
                                <th style="width: 5%;">م</th>
                                <th style="width: 35%;">الوصف</th>
                                <th style="width: 10%;">الوحدة</th>
                                <th style="width: 10%;">الكمية</th>
                                <th style="width: 15%;">سعر الوحدة</th>
                                <th style="width: 15%;">الإجمالي</th>
                                <th style="width: 10%;"></th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td>1</td>
                                <td><input type="text" placeholder="وصف البند"></td>
                                <td><input type="text" placeholder="قطعة" value="قطعة"></td>
                                <td><input type="number" placeholder="1" value="1" onchange="calculateRow(this)"></td>
                                <td><input type="number" placeholder="0.00" value="0" onchange="calculateRow(this)"></td>
                                <td><input type="number" placeholder="0.00" value="0" readonly></td>
                                <td><button class="section-btn" onclick="deleteRow(this)"><i class="fas fa-times"></i></button></td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="7">
                                    <button class="add-row-btn" onclick="addTableRow(this)">
                                        <i class="fas fa-plus"></i> إضافة بند جديد
                                    </button>
                                </td>
                            </tr>
                            <tr style="background: var(--gray-50);">
                                <td colspan="5" style="text-align: left; font-weight: 600;">المجموع الفرعي:</td>
                                <td colspan="2" style="font-weight: 600;">0.00 ر.س</td>
                            </tr>
                            <tr style="background: var(--gray-50);">
                                <td colspan="5" style="text-align: left; font-weight: 600;">ضريبة القيمة المضافة (15%):</td>
                                <td colspan="2" style="font-weight: 600;">0.00 ر.س</td>
                            </tr>
                            <tr style="background: linear-gradient(135deg, var(--gray-100), var(--gray-200));">
                                <td colspan="5" style="text-align: left; font-weight: 700; font-size: 18px;">الإجمالي النهائي:</td>
                                <td colspan="2" style="font-weight: 700; font-size: 18px; color: var(--primary);">0.00 ر.س</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
        }

        function createTermsComponent() {
            return `
                <div class="template-section" data-type="terms">
                    <div class="section-controls">
                        <button class="section-btn" onclick="moveUp(this)" title="نقل للأعلى">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="section-btn" onclick="moveDown(this)" title="نقل للأسفل">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button class="section-btn" onclick="editSection(this)" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="section-btn" onclick="deleteSection(this)" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <h3 style="margin-bottom: 18px; font-size: 20px;">الشروط والأحكام</h3>
                    <ol style="line-height: 2.2; color: var(--gray-600); font-size: 15px;" contenteditable="true">
                        <li>هذا العرض صالح لمدة 30 يوماً من تاريخ الإصدار.</li>
                        <li>شروط الدفع: 50% مقدماً، 50% عند الانتهاء من العمل.</li>
                        <li>جميع الأسعار بالريال السعودي وتشمل ضريبة القيمة المضافة 15%.</li>
                        <li>مدة التسليم: خلال 30 يوم عمل من تاريخ التأكيد.</li>
                        <li>الضمان: 12 شهر من تاريخ التسليم.</li>
                        <li>لا يشمل العرض أعمال إضافية خارج نطاق العمل المحدد.</li>
                        <li>يخضع هذا العقد للأنظمة واللوائح في المملكة العربية السعودية.</li>
                    </ol>
                </div>
            `;
        }

        function createSignatureComponent() {
            return `
                <div class="template-section" data-type="signature">
                    <div class="section-controls">
                        <button class="section-btn" onclick="moveUp(this)" title="نقل للأعلى">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="section-btn" onclick="moveDown(this)" title="نقل للأسفل">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button class="section-btn" onclick="editSection(this)" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="section-btn" onclick="deleteSection(this)" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 50px; margin-top: 50px;">
                        <div>
                            <div style="border-top: 2px solid var(--gray-300); padding-top: 10px;">
                                <strong style="font-size: 16px;">توقيع العميل</strong><br>
                                <span style="color: var(--gray-500); font-size: 14px;">الاسم والتاريخ</span>
                            </div>
                        </div>
                        <div>
                            <div style="border-top: 2px solid var(--gray-300); padding-top: 10px;">
                                <strong style="font-size: 16px;">ممثل الشركة</strong><br>
                                <span style="color: var(--gray-500); font-size: 14px;">الاسم والتاريخ</span>
                            </div>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--gray-200);">
                        <p style="color: var(--gray-500); font-size: 13px;">
                            <i class="fas fa-envelope"></i> info@company.sa | 
                            <i class="fas fa-phone"></i> 0500000000 | 
                            <i class="fas fa-globe"></i> www.company.sa
                        </p>
                    </div>
                </div>
            `;
        }

        function createTimelineComponent() {
            return `
                <div class="template-section" data-type="timeline">
                    <div class="section-controls">
                        <button class="section-btn" onclick="moveUp(this)" title="نقل للأعلى">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="section-btn" onclick="moveDown(this)" title="نقل للأسفل">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button class="section-btn" onclick="editSection(this)" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="section-btn" onclick="deleteSection(this)" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <h3 style="margin-bottom: 18px; font-size: 20px;">الجدول الزمني للمشروع</h3>
                    <div style="position: relative; padding-right: 35px;">
                        <div style="position: absolute; right: 10px; top: 0; bottom: 0; width: 3px; background: linear-gradient(180deg, var(--primary), var(--secondary));"></div>
                        <div style="margin-bottom: 25px;">
                            <div style="position: absolute; right: 6px; width: 11px; height: 11px; background: var(--primary); border-radius: 50%; box-shadow: 0 0 0 3px white, 0 0 0 6px rgba(30, 64, 175, 0.2);"></div>
                            <div contenteditable="true">
                                <strong style="font-size: 16px;">المرحلة الأولى: التخطيط والتصميم</strong><br>
                                <span style="color: var(--gray-500);">الأسبوع 1-2</span><br>
                                <span style="color: var(--gray-600); font-size: 14px;">إعداد المخططات والحصول على الموافقات</span>
                            </div>
                        </div>
                        <div style="margin-bottom: 25px;">
                            <div style="position: absolute; right: 6px; width: 11px; height: 11px; background: var(--primary); border-radius: 50%; box-shadow: 0 0 0 3px white, 0 0 0 6px rgba(30, 64, 175, 0.2);"></div>
                            <div contenteditable="true">
                                <strong style="font-size: 16px;">المرحلة الثانية: التنفيذ</strong><br>
                                <span style="color: var(--gray-500);">الأسبوع 3-8</span><br>
                                <span style="color: var(--gray-600); font-size: 14px;">تنفيذ الأعمال الأساسية والتشطيبات</span>
                            </div>
                        </div>
                        <div>
                            <div style="position: absolute; right: 6px; width: 11px; height: 11px; background: var(--primary); border-radius: 50%; box-shadow: 0 0 0 3px white, 0 0 0 6px rgba(30, 64, 175, 0.2);"></div>
                            <div contenteditable="true">
                                <strong style="font-size: 16px;">المرحلة الثالثة: التسليم والدعم</strong><br>
                                <span style="color: var(--gray-500);">الأسبوع 9-10</span><br>
                                <span style="color: var(--gray-600); font-size: 14px;">التسليم النهائي وفترة الضمان</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function createGalleryComponent() {
            return `
                <div class="template-section" data-type="gallery">
                    <div class="section-controls">
                        <button class="section-btn" onclick="moveUp(this)" title="نقل للأعلى">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="section-btn" onclick="moveDown(this)" title="نقل للأسفل">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button class="section-btn" onclick="editSection(this)" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="section-btn" onclick="deleteSection(this)" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <h3 style="margin-bottom: 18px; font-size: 20px;">نماذج من أعمالنا السابقة</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 18px;">
                        <div style="aspect-ratio: 1; background: linear-gradient(135deg, var(--gray-200), var(--gray-300)); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--gray-400); cursor: pointer;">
                            <i class="fas fa-image" style="font-size: 40px;"></i>
                        </div>
                        <div style="aspect-ratio: 1; background: linear-gradient(135deg, var(--gray-200), var(--gray-300)); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--gray-400); cursor: pointer;">
                            <i class="fas fa-image" style="font-size: 40px;"></i>
                        </div>
                        <div style="aspect-ratio: 1; background: linear-gradient(135deg, var(--gray-200), var(--gray-300)); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--gray-400); cursor: pointer;">
                            <i class="fas fa-image" style="font-size: 40px;"></i>
                        </div>
                    </div>
                </div>
            `;
        }

        function createPaymentComponent() {
            return `
                <div class="template-section" data-type="payment">
                    <div class="section-controls">
                        <button class="section-btn" onclick="moveUp(this)" title="نقل للأعلى">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="section-btn" onclick="moveDown(this)" title="نقل للأسفل">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button class="section-btn" onclick="editSection(this)" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="section-btn" onclick="deleteSection(this)" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <h3 style="margin-bottom: 18px; font-size: 20px;">جدول الدفعات</h3>
                    <table class="pricing-table">
                        <thead>
                            <tr>
                                <th>الدفعة</th>
                                <th>الوصف</th>
                                <th>النسبة</th>
                                <th>المبلغ</th>
                                <th>تاريخ الاستحقاق</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td contenteditable="true">الدفعة الأولى</td>
                                <td contenteditable="true">عند توقيع العقد</td>
                                <td contenteditable="true">30%</td>
                                <td contenteditable="true">يحسب تلقائياً</td>
                                <td contenteditable="true">فوري</td>
                            </tr>
                            <tr>
                                <td contenteditable="true">الدفعة الثانية</td>
                                <td contenteditable="true">منتصف المشروع</td>
                                <td contenteditable="true">40%</td>
                                <td contenteditable="true">يحسب تلقائياً</td>
                                <td contenteditable="true">بعد 30 يوم</td>
                            </tr>
                            <tr>
                                <td contenteditable="true">الدفعة النهائية</td>
                                <td contenteditable="true">عند التسليم</td>
                                <td contenteditable="true">30%</td>
                                <td contenteditable="true">يحسب تلقائياً</td>
                                <td contenteditable="true">عند الانتهاء</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        function createQRComponent() {
            return `
                <div class="template-section" data-type="qr">
                    <div class="section-controls">
                        <button class="section-btn" onclick="moveUp(this)" title="نقل للأعلى">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="section-btn" onclick="moveDown(this)" title="نقل للأسفل">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button class="section-btn" onclick="editSection(this)" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="section-btn" onclick="deleteSection(this)" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div style="text-align: center; padding: 30px;">
                        <h3 style="margin-bottom: 18px; font-size: 20px;">للدفع السريع</h3>
                        <div style="width: 200px; height: 200px; margin: 0 auto; background: linear-gradient(135deg, var(--gray-200), var(--gray-300)); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-qrcode" style="font-size: 100px; color: var(--gray-400);"></i>
                        </div>
                        <p style="margin-top: 18px; color: var(--gray-600); font-size: 14px;">
                            امسح الرمز للدفع عبر التطبيق البنكي
                        </p>
                    </div>
                </div>
            `;
        }

        function createDropZone(position) {
            return `
                <div class="drop-zone" data-position="${position}">
                    <div class="drop-zone-placeholder">
                        <i class="fas fa-plus-circle"></i>
                        <span>أضف مكوناً جديداً</span>
                    </div>
                </div>
            `;
        }

        // تهيئة محررات النص الغني
        function initializeEditors() {
            document.querySelectorAll('.text-editor').forEach(editor => {
                if (!editor.classList.contains('ql-container')) {
                    new Quill(editor, {
                        theme: 'snow',
                        modules: {
                            toolbar: [
                                ['bold', 'italic', 'underline', 'strike'],
                                ['blockquote', 'code-block'],
                                [{ 'header': 1 }, { 'header': 2 }],
                                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                [{ 'size': ['small', false, 'large', 'huge'] }],
                                [{ 'color': [] }, { 'background': [] }],
                                [{ 'font': [] }],
                                [{ 'align': [] }],
                                ['link'],
                                ['clean']
                            ]
                        }
                    });
                }
            });
        }

        // تحكمات الأقسام
        function moveUp(btn) {
            const section = btn.closest('.template-section');
            const prevElement = section.previousElementSibling;
            if (prevElement && prevElement.classList.contains('template-section')) {
                section.parentNode.insertBefore(section, prevElement);
                showNotification('تم نقل القسم للأعلى', 'success');
            }
        }

        function moveDown(btn) {
            const section = btn.closest('.template-section');
            const nextElement = section.nextElementSibling;
            if (nextElement && nextElement.classList.contains('template-section')) {
                section.parentNode.insertBefore(nextElement, section);
                showNotification('تم نقل القسم للأسفل', 'success');
            }
        }

        function editSection(btn) {
            const section = btn.closest('.template-section');
            // فتح لوحة الخصائص
            document.getElementById('propertiesPanel').classList.add('active');
            showNotification('قم بتعديل الخصائص من اللوحة الجانبية', 'info');
        }

        function deleteSection(btn) {
            if (confirm('هل أنت متأكد من حذف هذا القسم؟')) {
                const section = btn.closest('.template-section');
                section.remove();
                showNotification('تم حذف القسم بنجاح', 'success');
            }
        }

        // وظائف الجدول
        function addTableRow(btn) {
            const tbody = btn.closest('table').querySelector('tbody');
            const rowCount = tbody.querySelectorAll('tr').length;
            const newRow = tbody.insertRow(-1);
            newRow.innerHTML = `
                <td>${rowCount + 1}</td>
                <td><input type="text" placeholder="وصف البند"></td>
                <td><input type="text" placeholder="قطعة" value="قطعة"></td>
                <td><input type="number" placeholder="1" value="1" onchange="calculateRow(this)"></td>
                <td><input type="number" placeholder="0.00" value="0" onchange="calculateRow(this)"></td>
                <td><input type="number" placeholder="0.00" value="0" readonly></td>
                <td><button class="section-btn" onclick="deleteRow(this)"><i class="fas fa-times"></i></button></td>
            `;
            showNotification('تم إضافة بند جديد', 'success');
            updateCalculations();
        }

        function deleteRow(btn) {
            const row = btn.closest('tr');
            row.remove();
            updateRowNumbers();
            updateCalculations();
        }

        function calculateRow(input) {
            const row = input.closest('tr');
            const quantity = parseFloat(row.cells[3].querySelector('input').value) || 0;
            const price = parseFloat(row.cells[4].querySelector('input').value) || 0;
            const total = quantity * price;
            row.cells[5].querySelector('input').value = total.toFixed(2);
            updateCalculations();
        }

        function updateCalculations() {
            const table = document.querySelector('.pricing-table');
            if (!table) return;

            let subtotal = 0;
            const rows = table.querySelectorAll('tbody tr');

            rows.forEach(row => {
                const totalCell = row.cells[5].querySelector('input');
                if (totalCell) {
                    subtotal += parseFloat(totalCell.value) || 0;
                }
            });

            const vatRate = clampNumber(currentTemplate.settings.vat, 0, 100) / 100;
            const vat = subtotal * vatRate;
            const total = subtotal + vat;
            const vatPercentLabel = (vatRate * 100).toFixed(0);

            const tfoot = table.querySelector('tfoot');
            if (tfoot) {
                const footRows = tfoot.querySelectorAll('tr');
                if (footRows[1]) footRows[1].cells[1].textContent = formatCurrency(subtotal);
                if (footRows[2]) {
                    footRows[2].cells[0].textContent = `ضريبة القيمة المضافة (${vatPercentLabel}%):`;
                    footRows[2].cells[1].textContent = formatCurrency(vat);
                }
                if (footRows[3]) footRows[3].cells[1].textContent = formatCurrency(total);
            }
        }

        function updateRowNumbers() {
            const tbody = document.querySelector('#tableBody');
            if (tbody) {
                const rows = tbody.querySelectorAll('tr');
                rows.forEach((row, index) => {
                    row.cells[0].textContent = index + 1;
                });
            }
        }

        function bindControlEvents(element, handler) {
            if (!element) return;
            ['input', 'change'].forEach(eventName => {
                element.addEventListener(eventName, handler);
            });
        }

        // اختيارات الألوان
        function initializeColorPickers() {
            document.querySelectorAll('.color-picker').forEach(picker => {
                bindControlEvents(picker, (e) => {
                    const colorValue = e.target.parentElement.querySelector('.color-value');
                    if (colorValue) {
                        colorValue.value = e.target.value;
                    }
                    applyTemplateSettings();
                });
            });

            document.querySelectorAll('.color-value').forEach(input => {
                bindControlEvents(input, (e) => {
                    const colorPicker = e.target.parentElement.querySelector('.color-picker');
                    if (colorPicker) {
                        colorPicker.value = e.target.value;
                    }
                    applyTemplateSettings();
                });
            });
        }

        function initializePropertyControls() {
            const fontFamilySelect = document.getElementById('fontFamily');
            if (fontFamilySelect) {
                fontFamilySelect.value = currentTemplate.settings.fontFamily;
                bindControlEvents(fontFamilySelect, applyTemplateSettings);
            }

            const fontSizeSelect = document.getElementById('fontSize');
            if (fontSizeSelect) {
                fontSizeSelect.value = currentTemplate.settings.fontSize;
                bindControlEvents(fontSizeSelect, applyTemplateSettings);
            }

            const lineHeightSelect = document.getElementById('lineHeight');
            if (lineHeightSelect) {
                lineHeightSelect.value = currentTemplate.settings.lineHeight;
                bindControlEvents(lineHeightSelect, applyTemplateSettings);
            }

            const pageSizeSelect = document.getElementById('pageSize');
            if (pageSizeSelect) {
                pageSizeSelect.value = currentTemplate.settings.pageSize;
                bindControlEvents(pageSizeSelect, applyTemplateSettings);
            }

            const pageOrientationSelect = document.getElementById('pageOrientation');
            if (pageOrientationSelect) {
                pageOrientationSelect.value = currentTemplate.settings.pageOrientation;
                bindControlEvents(pageOrientationSelect, applyTemplateSettings);
            }

            const pageMarginInput = document.getElementById('pageMargin');
            if (pageMarginInput) {
                pageMarginInput.value = currentTemplate.settings.pageMargin;
                bindControlEvents(pageMarginInput, applyTemplateSettings);
            }

            const vatInput = document.getElementById('vatRate');
            if (vatInput) {
                vatInput.value = currentTemplate.settings.vat;
                bindControlEvents(vatInput, applyTemplateSettings);
            }

            const currencySelect = document.getElementById('currency');
            if (currencySelect) {
                currencySelect.value = currentTemplate.settings.currency;
                bindControlEvents(currencySelect, applyTemplateSettings);
            }
        }

        function applyStoredSettingsToInputs(settings) {
            const handlers = [
                { id: 'fontFamily', key: 'fontFamily' },
                { id: 'fontSize', key: 'fontSize' },
                { id: 'lineHeight', key: 'lineHeight' },
                { id: 'pageSize', key: 'pageSize' },
                { id: 'pageOrientation', key: 'pageOrientation' },
                { id: 'pageMargin', key: 'pageMargin' },
                { id: 'vatRate', key: 'vat' },
                { id: 'currency', key: 'currency' }
            ];

            handlers.forEach(({ id, key }) => {
                if (settings[key] !== undefined && settings[key] !== null) {
                    const element = document.getElementById(id);
                    if (element) {
                        element.value = settings[key];
                    }
                }
            });
        }

        function applyTemplateSettings() {
            const documentCanvas = document.getElementById('documentCanvas');
            if (!documentCanvas) return;
            const bgColor = document.getElementById('bgColor')?.value || currentTemplate.settings.bgColor;
            const primaryColor = document.getElementById('primaryColor')?.value || currentTemplate.settings.primaryColor;
            const fontFamily = document.getElementById('fontFamily')?.value || currentTemplate.settings.fontFamily;
            const fontSize = document.getElementById('fontSize')?.value || currentTemplate.settings.fontSize;
            const lineHeight = document.getElementById('lineHeight')?.value || currentTemplate.settings.lineHeight;
            const pageSize = document.getElementById('pageSize')?.value || currentTemplate.settings.pageSize;
            const pageOrientation = document.getElementById('pageOrientation')?.value || currentTemplate.settings.pageOrientation;
            const pageMargin = normalizeMarginValue(document.getElementById('pageMargin')?.value || currentTemplate.settings.pageMargin);
            const vatRate = clampNumber(document.getElementById('vatRate')?.value ?? currentTemplate.settings.vat, 0, 100);
            const currency = document.getElementById('currency')?.value || currentTemplate.settings.currency;

            documentCanvas.style.background = bgColor;
            documentCanvas.style.fontFamily = fontFamily;
            documentCanvas.style.fontSize = fontSize;
            documentCanvas.style.lineHeight = lineHeight;
            documentCanvas.style.padding = pageMargin;

            const bgColorInput = document.getElementById('bgColor');
            if (bgColorInput) {
                bgColorInput.value = bgColor;
                if (bgColorInput.nextElementSibling) {
                    bgColorInput.nextElementSibling.value = bgColor;
                }
            }

            const primaryColorInput = document.getElementById('primaryColor');
            if (primaryColorInput) {
                primaryColorInput.value = primaryColor;
                if (primaryColorInput.nextElementSibling) {
                    primaryColorInput.nextElementSibling.value = primaryColor;
                }
            }

            const dimensions = getPageSizeDimensions(pageSize, pageOrientation);
            documentCanvas.style.width = `${dimensions.width}px`;
            documentCanvas.style.minHeight = `${dimensions.height}px`;

            document.documentElement.style.setProperty('--primary', primaryColor);

            currentTemplate.settings = {
                ...currentTemplate.settings,
                bgColor,
                primaryColor,
                fontFamily,
                fontSize,
                lineHeight,
                pageSize,
                pageOrientation,
                pageMargin,
                vat: vatRate,
                currency
            };

            const vatInput = document.getElementById('vatRate');
            if (vatInput) {
                vatInput.value = vatRate;
            }

            updateCalculations();
        }

        function normalizeMarginValue(value) {
            const numeric = parseInt(value, 10);
            if (Number.isNaN(numeric)) return currentTemplate.settings.pageMargin;
            return `${numeric}px`;
        }

        function getPageSizeDimensions(size, orientation) {
            const sizes = {
                A4: { width: 794, height: 1123 },
                Letter: { width: 816, height: 1056 },
                Legal: { width: 816, height: 1344 }
            };
            const selected = sizes[size] || sizes.A4;
            if (orientation === 'أفقي') {
                return { width: selected.height, height: selected.width };
            }
            return selected;
        }

        function clampNumber(value, min, max) {
            const numeric = parseFloat(value);
            if (Number.isNaN(numeric)) return min;
            return Math.min(Math.max(numeric, min), max);
        }

        function getCurrencySymbol(code) {
            const symbols = {
                SAR: 'ر.س',
                USD: '$',
                EUR: '€',
                AED: 'د.إ',
                EGP: 'ج.م'
            };
            return symbols[code] || code || 'ر.س';
        }

        function formatCurrency(value) {
            const numericValue = parseFloat(value) || 0;
            const symbol = getCurrencySymbol(currentTemplate.settings.currency);
            return `${numericValue.toFixed(2)} ${symbol}`;
        }

        // إجراءات القالب
        function goBack() {
            if (confirm('هل أنت متأكد؟ قد تفقد التغييرات غير المحفوظة.')) {
                redirectToReturnPage();
            }
        }

        function previewTemplate() {
            // فتح نافذة المعاينة
            const previewWindow = window.open('', 'معاينة', 'width=900,height=700');
            const content = document.getElementById('documentCanvas').innerHTML;
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <title>معاينة القالب</title>
                    <style>
                        body { font-family: 'Cairo', sans-serif; padding: 40px; direction: rtl; }
                        .drop-zone { display: none; }
                        .section-controls { display: none; }
                        * { font-family: 'Cairo', sans-serif; }
                    </style>
                </head>
                <body>${content}</body>
                </html>
            `);
        }

        function printTemplate() {
            applyTemplateSettings();
            const canvas = document.getElementById('documentCanvas');
            if (!canvas) return;

            const content = canvas.innerHTML;
            const pageSize = getPrintablePageSize(currentTemplate.settings.pageSize);
            const orientation = currentTemplate.settings.pageOrientation === 'أفقي' ? 'landscape' : 'portrait';
            const margin = normalizeMarginValue(currentTemplate.settings.pageMargin || '40px');

            const printWindow = window.open('', 'طباعة', 'width=1024,height=1366');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <title>طباعة القالب</title>
                    <style>
                        @page { size: ${pageSize} ${orientation}; margin: ${margin}; }
                        body { font-family: 'Cairo', sans-serif; direction: rtl; background: white; }
                        .drop-zone, .section-controls { display: none !important; }
                        .document-preview { width: 100%; box-shadow: none; padding: 0; margin: 0; }
                    </style>
                </head>
                <body>
                    <div class="document-preview">${content}</div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            printWindow.onload = () => printWindow.print();
        }

        function getPrintablePageSize(size) {
            const supported = ['A4', 'Letter', 'Legal'];
            return supported.includes(size) ? size : 'A4';
        }

        async function saveAsDraft() {
            showLoading();
            try {
                const template = await persistTemplate('draft');
                if (template) {
                    showNotification(`تم حفظ "${template.title}" كمسودة`, 'success');
                }
            } finally {
                hideLoading();
            }
        }

        async function publishTemplate() {
            showLoading();
            try {
                const template = await persistTemplate('published');
                if (template) {
                    showNotification(`تم نشر "${template.title}" بنجاح`, 'success');
                    setTimeout(() => redirectToReturnPage(), 800);
                }
            } finally {
                hideLoading();
            }
        }

        async function persistTemplate(status = 'draft') {
            const canvas = document.getElementById('documentCanvas');
            if (!canvas) return null;

            const templateNameInput = document.getElementById('templateName');
            const categorySelect = document.getElementById('templateCategory');

            const templateTitle = templateNameInput ? (templateNameInput.value.trim() || 'قالب بدون اسم') : 'قالب بدون اسم';
            const templateCategory = categorySelect ? categorySelect.value : 'quotation';

            currentTemplate.name = templateTitle;
            currentTemplate.category = templateCategory;
            currentTemplate.status = status;
            currentTemplate.id = currentTemplate.serverId || currentTemplate.id || `custom-${Date.now()}`;

            const now = new Date();
            const templateTags = Array.isArray(currentTemplate.tags) ? currentTemplate.tags : [];
            const templateData = {
                id: currentTemplate.serverId || currentTemplate.id,
                title: templateTitle,
                category: templateCategory,
                status,
                description: `آخر تحديث: ${formatArDateTime(now)}`,
                updatedAt: now.toISOString(),
                html: canvas.innerHTML,
                settings: { ...currentTemplate.settings },
                tags: templateTags,
                source: canUseServerStorage() ? 'server' : currentTemplate.source || 'custom'
            };

            const payload = {
                name: templateTitle,
                title: templateTitle,
                type: templateCategory,
                category: templateCategory,
                status,
                description: templateData.description,
                html: templateData.html,
                settings: currentTemplate.settings,
                tags: templateTags,
                isPublic: false
            };

            if (canUseServerStorage()) {
                try {
                    const savedTemplate = await saveTemplateToServer(payload);
                    if (savedTemplate) {
                        currentTemplate.serverId = savedTemplate.id;
                        currentTemplate.id = savedTemplate.id;
                        currentTemplate.source = 'server';
                        templateData.id = savedTemplate.id;
                        templateData.status = savedTemplate.status || status;
                        templateData.description = savedTemplate.description || templateData.description;
                        templateData.updatedAt = savedTemplate.updatedAt || templateData.updatedAt;
                        templateData.html = savedTemplate.html || templateData.html;
                        templateData.source = 'server';
                        templateData.tags = savedTemplate.tags || templateData.tags;
                        updateLocalTemplateCache(templateData);
                        return templateData;
                    }
                } catch (error) {
                    console.error('فشل حفظ القالب على الخادم:', error);
                    showNotification('تعذر الحفظ على الخادم، سيتم استخدام التخزين المحلي مؤقتاً', 'error');
                }
            }

            if (typeof localStorage === 'undefined') {
                showNotification('التخزين المحلي غير متاح في هذا المتصفح', 'error');
                return null;
            }

            templateData.source = templateData.source || 'custom';
            currentTemplate.source = templateData.source;
            updateLocalTemplateCache(templateData);
            return templateData;
        }

        function formatArDateTime(date) {
            try {
                const normalized = date instanceof Date ? date : new Date(date);
                return new Intl.DateTimeFormat('ar-SA', {
                    dateStyle: 'medium',
                    timeStyle: 'short'
                }).format(normalized);
            } catch (error) {
                try {
                    return new Date(date).toLocaleString('ar-SA');
                } catch (fallbackError) {
                    console.warn('تعذر تنسيق التاريخ العربي:', fallbackError);
                    return '';
                }
            }
        }

        function redirectToReturnPage() {
            if (returnPage === 'document-workspace') {
                const params = new URLSearchParams();
                params.set('type', currentTemplate.category || 'quotation');
                if (currentTemplate.serverId || currentTemplate.id) {
                    params.set('templateId', currentTemplate.serverId || currentTemplate.id);
                }
                params.set('source', currentTemplate.serverId ? 'server' : (currentTemplate.source || 'custom'));
                params.set('title', currentTemplate.name || 'قالب مخصص');
                window.location.href = `document_workspace.html?${params.toString()}`;
                return;
            }

            if (returnPage && returnPage !== 'dashboard') {
                window.location.href = `index.html?page=${returnPage}`;
            } else {
                window.location.href = 'index.html';
            }
        }

        function uploadLogo() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    showNotification('تم رفع الشعار بنجاح', 'success');
                }
            };
            input.click();
        }

        // أدوات مساعدة
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        function showNotification(message, type = 'info') {
            // إنشاء عنصر الإشعار
            const notification = document.createElement('div');
            const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'times-circle' : 'info-circle';
            const bgColor = type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : 'var(--info)';
            
            notification.style.cssText = `
                position: fixed;
                bottom: 30px;
                left: 30px;
                padding: 16px 24px;
                background: ${bgColor};
                color: white;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
                z-index: 10000;
                animation: slideInUp 0.3s ease-out;
                display: flex;
                align-items: center;
                gap: 12px;
                font-weight: 600;
                font-family: 'Cairo', sans-serif;
            `;
            
            notification.innerHTML = `<i class="fas fa-${icon}"></i> ${message}`;
            document.body.appendChild(notification);

            // إزالة بعد 3 ثوان
            setTimeout(() => {
                notification.style.animation = 'slideOutDown 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // إضافة أنماط الحركة
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInUp {
                from {
                    transform: translateY(100%);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
            @keyframes slideOutDown {
                from {
                    transform: translateY(0);
                    opacity: 1;
                }
                to {
                    transform: translateY(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محرر القوالب - منصة الفواتير الاحترافية</title>
    
    <!-- External Dependencies -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800;900&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <!-- Quill Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1e40af;
            --primary-dark: #1e3a8a;
            --secondary: #0891b2;
            --success: #059669;
            --danger: #dc2626;
            --warning: #d97706;
            --info: #0284c7;
            --dark: #0f172a;
            --light: #f8fafc;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        body {
            font-family: 'Cairo', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-100);
            color: var(--dark);
            overflow: hidden;
            direction: rtl;
        }

        /* شريط الأدوات */
        .editor-toolbar {
            height: 65px;
            background: white;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            position: fixed;
            top: 0;
            right: 0;
            left: 0;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
        }

        .toolbar-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .toolbar-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toolbar-title input {
            font-size: 18px;
            font-weight: 600;
            border: none;
            background: transparent;
            padding: 10px 14px;
            border-radius: 8px;
            transition: all 0.2s;
            font-family: 'Cairo', sans-serif;
            width: 300px;
        }

        .toolbar-title input:hover {
            background: var(--gray-100);
        }

        .toolbar-title input:focus {
            outline: none;
            background: var(--gray-100);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        .toolbar-actions {
            display: flex;
            gap: 10px;
        }

        .toolbar-btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: 'Cairo', sans-serif;
        }

        .toolbar-btn.primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 2px 8px rgba(30, 64, 175, 0.3);
        }

        .toolbar-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 64, 175, 0.4);
        }

        .toolbar-btn.secondary {
            background: white;
            color: var(--gray-700);
            border: 2px solid var(--gray-300);
        }

        .toolbar-btn.secondary:hover {
            background: var(--gray-100);
            border-color: var(--primary);
            color: var(--primary);
        }

        /* منطقة المحرر الرئيسية */
        .editor-main {
            display: flex;
            flex: 1;
            margin-top: 65px;
            height: calc(100vh - 65px);
        }

        /* لوحة المكونات */
        .components-panel {
            width: 300px;
            background: white;
            border-left: 1px solid var(--gray-200);
            overflow-y: auto;
            padding: 24px;
        }

        .panel-title {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--gray-500);
            margin-bottom: 18px;
            letter-spacing: 0.5px;
        }

        .component-category {
            margin-bottom: 28px;
        }

        .component-item {
            background: linear-gradient(135deg, var(--gray-50), var(--gray-100));
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            cursor: move;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            overflow: hidden;
        }

        .component-item::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--primary), var(--secondary));
            transform: translateX(100%);
            transition: transform 0.3s;
        }

        .component-item:hover {
            border-color: var(--primary);
            transform: translateX(-4px);
            box-shadow: 0 4px 12px rgba(30, 64, 175, 0.15);
        }

        .component-item:hover::before {
            transform: translateX(0);
        }

        .component-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .component-icon {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 18px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .component-info {
            flex: 1;
        }

        .component-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 2px;
        }

        .component-desc {
            font-size: 12px;
            color: var(--gray-500);
        }

        /* منطقة اللوحة */
        .editor-canvas {
            flex: 1;
            background: var(--gray-100);
            overflow-y: auto;
            padding: 40px;
            position: relative;
        }

        .canvas-wrapper {
            max-width: 850px;
            margin: 0 auto;
        }

        .document-preview {
            background: white;
            min-height: 1188px; /* A4 نسبة */
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
            border-radius: 12px;
            padding: 60px;
            position: relative;
        }

        /* مناطق الإسقاط */
        .drop-zone {
            min-height: 100px;
            border: 3px dashed var(--gray-300);
            border-radius: 12px;
            margin: 20px 0;
            padding: 30px;
            text-align: center;
            color: var(--gray-400);
            transition: all 0.3s;
            position: relative;
            background: var(--gray-50);
        }

        .drop-zone.drag-over {
            background: linear-gradient(135deg, rgba(30, 64, 175, 0.05), rgba(8, 145, 178, 0.05));
            border-color: var(--primary);
            transform: scale(1.02);
        }

        .drop-zone-placeholder {
            font-size: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: 500;
        }

        .drop-zone-placeholder i {
            font-size: 24px;
            color: var(--primary);
        }

        /* أقسام القالب */
        .template-section {
            margin-bottom: 28px;
            padding: 24px;
            background: linear-gradient(135deg, var(--gray-50), white);
            border-radius: 12px;
            position: relative;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .template-section:hover {
            border-color: var(--primary);
            box-shadow: 0 8px 24px rgba(30, 64, 175, 0.12);
            transform: translateY(-2px);
        }

        .section-controls {
            position: absolute;
            top: 12px;
            left: 12px;
            display: flex;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .template-section:hover .section-controls {
            opacity: 1;
        }

        .section-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-600);
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .section-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }

        /* قسم الرأس */
        .header-section {
            display: flex;
            align-items: center;
            gap: 35px;
            padding-bottom: 25px;
            border-bottom: 3px solid var(--gray-200);
            margin-bottom: 35px;
        }

        .company-logo {
            width: 130px;
            height: 130px;
            background: linear-gradient(135deg, var(--gray-200), var(--gray-300));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-400);
            font-size: 48px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .company-logo::before {
            content: 'انقر للرفع';
            position: absolute;
            bottom: 8px;
            font-size: 11px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .company-logo:hover {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .company-logo:hover::before {
            opacity: 1;
        }

        .company-info {
            flex: 1;
        }

        .company-name {
            font-size: 32px;
            font-weight: 800;
            color: var(--gray-900);
            margin-bottom: 10px;
        }

        .company-details {
            color: var(--gray-600);
            line-height: 1.8;
            font-size: 15px;
        }

        /* جدول الأسعار */
        .pricing-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 24px 0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .pricing-table th {
            background: linear-gradient(135deg, var(--gray-100), var(--gray-200));
            padding: 14px;
            text-align: right;
            font-weight: 600;
            font-size: 14px;
            color: var(--gray-700);
            border-bottom: 2px solid var(--gray-300);
        }

        .pricing-table td {
            padding: 14px;
            border-bottom: 1px solid var(--gray-200);
            font-size: 14px;
            background: white;
        }

        .pricing-table tr:last-child td {
            border-bottom: none;
        }

        .pricing-table input {
            width: 100%;
            border: none;
            background: transparent;
            padding: 6px;
            font-family: 'Cairo', sans-serif;
            font-size: 14px;
        }

        .pricing-table input:focus {
            outline: none;
            background: var(--gray-50);
            border-radius: 4px;
        }

        .add-row-btn {
            width: 100%;
            padding: 12px;
            border: 2px dashed var(--gray-300);
            background: transparent;
            border-radius: 8px;
            color: var(--gray-500);
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
        }

        .add-row-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(30, 64, 175, 0.05);
        }

        /* لوحة الخصائص */
        .properties-panel {
            width: 340px;
            background: white;
            border-right: 1px solid var(--gray-200);
            overflow-y: auto;
            padding: 24px;
        }

        .property-group {
            margin-bottom: 28px;
        }

        .property-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 8px;
        }

        .property-input {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid var(--gray-300);
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Cairo', sans-serif;
            transition: all 0.2s;
        }

        .property-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        .color-picker-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .color-picker {
            width: 45px;
            height: 45px;
            border: 2px solid var(--gray-300);
            border-radius: 8px;
            cursor: pointer;
        }

        .color-value {
            flex: 1;
        }

        /* التوافق مع الجوال */
        @media (max-width: 1024px) {
            .components-panel {
                display: none;
            }

            .properties-panel {
                position: fixed;
                left: -340px;
                top: 65px;
                height: calc(100vh - 65px);
                transition: left 0.3s;
                z-index: 999;
                box-shadow: 4px 0 6px -1px rgb(0 0 0 / 0.1);
            }

            .properties-panel.active {
                left: 0;
            }
        }

        @media (max-width: 768px) {
            .editor-canvas {
                padding: 20px;
            }

            .document-preview {
                padding: 30px;
            }

            .toolbar-title input {
                font-size: 16px;
                max-width: 150px;
            }
        }

        /* محرر النص الغني */
        .text-editor {
            min-height: 120px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            background: white;
        }

        .ql-toolbar {
            border-top-right-radius: 8px;
            border-top-left-radius: 8px;
            direction: rtl;
        }

        .ql-container {
            border-bottom-right-radius: 8px;
            border-bottom-left-radius: 8px;
            font-family: 'Cairo', sans-serif;
            direction: rtl;
        }

        .ql-editor {
            direction: rtl;
            text-align: right;
        }

        /* حالة التحميل */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid white;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* تخصيص شريط التمرير */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--gray-100);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gray-400);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
    </style>
</head>
<body>
    <!-- شريط الأدوات -->
    <div class="editor-toolbar">
        <div class="toolbar-right">
            <button class="toolbar-btn secondary" onclick="goBack()">
                <i class="fas fa-arrow-right"></i>
                رجوع
            </button>
            <div class="toolbar-title">
                <input type="text" value="قالب عرض سعر البناء" id="templateName">
            </div>
        </div>
        <div class="toolbar-actions">
            <button class="toolbar-btn secondary" onclick="previewTemplate()">
                <i class="fas fa-eye"></i>
                معاينة
            </button>
            <button class="toolbar-btn secondary" onclick="saveAsDraft()">
                <i class="fas fa-save"></i>
                حفظ كمسودة
            </button>
            <button class="toolbar-btn primary" onclick="publishTemplate()">
                <i class="fas fa-check"></i>
                حفظ ونشر
            </button>
        </div>
    </div>

    <!-- منطقة المحرر الرئيسية -->
    <div class="editor-main">
        <!-- لوحة المكونات -->
        <div class="components-panel">
            <div class="panel-title">المكونات الأساسية</div>
            
            <!-- المكونات الأساسية -->
            <div class="component-category">
                <div class="component-item" draggable="true" data-component="header">
                    <div class="component-icon">
                        <i class="fas fa-heading"></i>
                    </div>
                    <div class="component-info">
                        <div class="component-name">رأس الصفحة</div>
                        <div class="component-desc">معلومات الشركة والشعار</div>
                    </div>
                </div>

                <div class="component-item" draggable="true" data-component="client">
                    <div class="component-icon">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="component-info">
                        <div class="component-name">بيانات العميل</div>
                        <div class="component-desc">معلومات العميل</div>
                    </div>
                </div>

                <div class="component-item" draggable="true" data-component="text">
                    <div class="component-icon">
                        <i class="fas fa-paragraph"></i>
                    </div>
                    <div class="component-info">
                        <div class="component-name">نص حر</div>
                        <div class="component-desc">محتوى نصي منسق</div>
                    </div>
                </div>

                <div class="component-item" draggable="true" data-component="table">
                    <div class="component-icon">
                        <i class="fas fa-table"></i>
                    </div>
                    <div class="component-info">
                        <div class="component-name">جدول الأسعار</div>
                        <div class="component-desc">البنود والأسعار</div>
                    </div>
                </div>

                <div class="component-item" draggable="true" data-component="terms">
                    <div class="component-icon">
                        <i class="fas fa-list"></i>
                    </div>
                    <div class="component-info">
                        <div class="component-name">الشروط والأحكام</div>
                        <div class="component-desc">البنود القانونية</div>
                    </div>
                </div>

                <div class="component-item" draggable="true" data-component="signature">
                    <div class="component-icon">
                        <i class="fas fa-signature"></i>
                    </div>
                    <div class="component-info">
                        <div class="component-name">التوقيع</div>
                        <div class="component-desc">مكان التوقيع</div>
                    </div>
                </div>
            </div>

            <!-- المكونات المتقدمة -->
            <div class="panel-title">المكونات المتقدمة</div>
            <div class="component-category">
                <div class="component-item" draggable="true" data-component="timeline">
                    <div class="component-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="component-info">
                        <div class="component-name">الجدول الزمني</div>
                        <div class="component-desc">مراحل المشروع</div>
                    </div>
                </div>

                <div class="component-item" draggable="true" data-component="gallery">
                    <div class="component-icon">
                        <i class="fas fa-images"></i>
                    </div>
                    <div class="component-info">
                        <div class="component-name">معرض الصور</div>
                        <div class="component-desc">صور المنتجات</div>
                    </div>
                </div>

                <div class="component-item" draggable="true" data-component="payment">
                    <div class="component-icon">
                        <i class="fas fa-credit-card"></i>
                    </div>
                    <div class="component-info">
                        <div class="component-name">جدول الدفعات</div>
                        <div class="component-desc">خطة السداد</div>
                    </div>
                </div>

                <div class="component-item" draggable="true" data-component="qr">
                    <div class="component-icon">
                        <i class="fas fa-qrcode"></i>
                    </div>
                    <div class="component-info">
                        <div class="component-name">رمز QR</div>
                        <div class="component-desc">رمز سريع للدفع</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- منطقة اللوحة -->
        <div class="editor-canvas">
            <div class="canvas-wrapper">
                <div class="document-preview" id="documentCanvas">
                    <!-- منطقة الإسقاط الأولية -->
                    <div class="drop-zone" data-position="0">
                        <div class="drop-zone-placeholder">
                            <i class="fas fa-plus-circle"></i>
                            <span>اسحب المكونات هنا لبدء البناء</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- لوحة الخصائص -->
        <div class="properties-panel" id="propertiesPanel">
            <div class="panel-title">خصائص القالب</div>
            
            <div class="property-group">
                <label class="property-label">لون الخلفية</label>
                <div class="color-picker-group">
                    <input type="color" class="color-picker" value="#ffffff" id="bgColor">
                    <input type="text" class="property-input color-value" value="#ffffff">
                </div>
            </div>

            <div class="property-group">
                <label class="property-label">اللون الرئيسي</label>
                <div class="color-picker-group">
                    <input type="color" class="color-picker" value="#1e40af" id="primaryColor">
                    <input type="text" class="property-input color-value" value="#1e40af">
                </div>
            </div>

            <div class="property-group">
                <label class="property-label">نوع الخط</label>
                <select class="property-input">
                    <option>Cairo</option>
                    <option>Amiri</option>
                    <option>Tajawal</option>
                    <option>Almarai</option>
                    <option>Noto Kufi Arabic</option>
                </select>
            </div>

            <div class="property-group">
                <label class="property-label">حجم الخط</label>
                <select class="property-input">
                    <option>12px</option>
                    <option selected>14px</option>
                    <option>16px</option>
                    <option>18px</option>
                </select>
            </div>

            <div class="property-group">
                <label class="property-label">ارتفاع السطر</label>
                <select class="property-input">
                    <option>1.4</option>
                    <option>1.6</option>
                    <option selected>1.8</option>
                    <option>2.0</option>
                </select>
            </div>

            <div class="panel-title" style="margin-top: 35px;">إعدادات الصفحة</div>

            <div class="property-group">
                <label class="property-label">حجم الصفحة</label>
                <select class="property-input">
                    <option selected>A4</option>
                    <option>Letter</option>
                    <option>Legal</option>
                    <option>مخصص</option>
                </select>
            </div>

            <div class="property-group">
                <label class="property-label">اتجاه الصفحة</label>
                <select class="property-input">
                    <option selected>عمودي</option>
                    <option>أفقي</option>
                </select>
            </div>

            <div class="property-group">
                <label class="property-label">الهوامش</label>
                <input type="text" class="property-input" value="60px">
            </div>

            <div class="panel-title" style="margin-top: 35px;">الضريبة والعملة</div>

            <div class="property-group">
                <label class="property-label">نسبة الضريبة</label>
                <input type="number" class="property-input" value="15" min="0" max="100">
            </div>

            <div class="property-group">
                <label class="property-label">العملة</label>
                <select class="property-input">
                    <option selected>ريال سعودي (SAR)</option>
                    <option>دولار أمريكي (USD)</option>
                    <option>يورو (EUR)</option>
                    <option>درهم إماراتي (AED)</option>
                    <option>جنيه مصري (EGP)</option>
                </select>
            </div>
        </div>
    </div>

    <!-- طبقة التحميل -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        // إدارة الحالة
        let draggedElement = null;
        let currentTemplate = {
            name: 'قالب عرض سعر البناء',
            sections: [],
            settings: {
                bgColor: '#ffffff',
                primaryColor: '#1e40af',
                fontFamily: 'Cairo',
                fontSize: '14px',
                lineHeight: '1.8',
                vat: 15,
                currency: 'SAR'
            }
        };

        // التهيئة
        document.addEventListener('DOMContentLoaded', () => {
            initializeDragDrop();
            initializeColorPickers();
            showNotification('مرحباً! ابدأ بسحب المكونات إلى اللوحة', 'info');
        });

        // السحب والإفلات
        function initializeDragDrop() {
            // عناصر المكونات
            document.querySelectorAll('.component-item').forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
            });

            // تحديث مناطق الإسقاط
            updateDropZones();
        }

        function handleDragStart(e) {
            draggedElement = e.target.closest('.component-item');
            draggedElement.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('component', draggedElement.dataset.component);
        }

        function handleDragEnd(e) {
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
                draggedElement = null;
            }
        }

        function updateDropZones() {
            const canvas = document.getElementById('documentCanvas');
            const dropZones = canvas.querySelectorAll('.drop-zone');
            
            dropZones.forEach(zone => {
                zone.addEventListener('dragover', handleDragOver);
                zone.addEventListener('drop', handleDrop);
                zone.addEventListener('dragleave', handleDragLeave);
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            const componentType = e.dataTransfer.getData('component');
            const position = parseInt(e.currentTarget.dataset.position);
            
            addComponent(componentType, position);
        }

        // إنشاء المكونات
        function addComponent(type, position) {
            const canvas = document.getElementById('documentCanvas');
            let componentHTML = '';
            
            switch(type) {
                case 'header':
                    componentHTML = createHeaderComponent();
                    break;
                case 'client':
                    componentHTML = createClientComponent();
                    break;
                case 'text':
                    componentHTML = createTextComponent();
                    break;
                case 'table':
                    componentHTML = createTableComponent();
                    break;
                case 'terms':
                    componentHTML = createTermsComponent();
                    break;
                case 'signature':
                    componentHTML = createSignatureComponent();
                    break;
                case 'timeline':
                    componentHTML = createTimelineComponent();
                    break;
                case 'gallery':
                    componentHTML = createGalleryComponent();
                    break;
                case 'payment':
                    componentHTML = createPaymentComponent();
                    break;
                case 'qr':
                    componentHTML = createQRComponent();
                    break;
            }
            
            // إدراج المكون
            const dropZone = canvas.querySelector(`.drop-zone[data-position="${position}"]`);
            dropZone.outerHTML = componentHTML + createDropZone(position + 1);
            
            // إعادة التهيئة
            updateDropZones();
            initializeEditors();
            showNotification('تم إضافة المكون بنجاح', 'success');
        }

        // قوالب المكونات
        function createHeaderComponent() {
            return `
                <div class="template-section" data-type="header">
                    <div class="section-controls">
                        <button class="section-btn" onclick="moveUp(this)" title="نقل للأعلى">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="section-btn" onclick="moveDown(this)" title="نقل للأسفل">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button class="section-btn" onclick="editSection(this)" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="section-btn" onclick="deleteSection(this)" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="header-section">
                        <div class="company-logo" onclick="uploadLogo()">
                            <i class="fas fa-building"></i>
                        </div>
                        <div class="company-info">
                            <div class="company-name" contenteditable="true">اسم شركتك</div>
                            <div class="company-details" contenteditable="true">
                                العنوان: شارع الملك فهد، الرياض 12345<br>
                                الهاتف: 0500000000 | البريد: info@company.sa<br>
                                الموقع: www.company.sa | السجل التجاري: 1234567890
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function createClientComponent() {
            return `
                <div class="template-section" data-type="client">
                    <div class="section-controls">
                        <button class="section-btn" onclick="moveUp(this)" title="نقل للأعلى">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="section-btn" onclick="moveDown(this)" title="نقل للأسفل">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button class="section-btn" onclick="editSection(this)" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="section-btn" onclick="deleteSection(this)" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 35px;">
                        <div>
                            <h3 style="margin-bottom: 14px; color: var(--gray-700); font-size: 18px;">بيانات العميل</h3>
                            <div contenteditable="true" style="line-height: 2; color: var(--gray-600); font-size: 15px;">
                                السيد/ [اسم العميل]<br>
                                الشركة: [اسم الشركة]<br>
                                العنوان: [العنوان]<br>
                                الجوال: [رقم الجوال]<br>
                                البريد: [البريد الإلكتروني]
                            </div>
                        </div>
                        <div>
                            <h3 style="margin-bottom: 14px; color: var(--gray-700); font-size: 18px;">تفاصيل العرض</h3>
                            <div contenteditable="true" style="line-height: 2; color: var(--gray-600); font-size: 15px;">
                                رقم العرض: QUO-2025-001<br>
                                التاريخ: ${new Date().toLocaleDateString('ar-SA')}<br>
                                صالح حتى: ${new Date(Date.now() + 30*24*60*60*1000).toLocaleDateString('ar-SA')}<br>
                                المشروع: [اسم المشروع]<br>
                                المعد: [اسم الموظف]
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function createTextComponent() {
            const id = 'editor-' + Date.now();
            return `
                <div class="template-section" data-type="text">
                    <div class="section-controls">
                        <button class="section-btn" onclick="moveUp(this)" title="نقل للأعلى">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="section-btn" onclick="moveDown(this)" title="نقل للأسفل">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button class="section-btn" onclick="editSection(this)" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="section-btn" onclick="deleteSection(this)" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div id="${id}" class="text-editor">
                        <p>السادة/ [اسم العميل] المحترمين</p>
                        <p>تحية طيبة وبعد،</p>
                        <p>يسرنا أن نتقدم لسيادتكم بعرض السعر الخاص بمشروع [اسم المشروع]، وفقاً للمواصفات المطلوبة.</p>
                    </div>
                </div>
            `;
        }

        function createTableComponent() {
            return `
                <div class="template-section" data-type="table">
                    <div class="section-controls">
                        <button class="section-btn" onclick="moveUp(this)" title="نقل للأعلى">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="section-btn" onclick="moveDown(this)" title="نقل للأسفل">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button class="section-btn" onclick="editSection(this)" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="section-btn" onclick="deleteSection(this)" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <h3 style="margin-bottom: 18px; font-size: 20px;">بنود العرض</h3>
                    <table class="pricing-table">
                        <thead>
                            <tr>
                                <th style="width: 5%;">م</th>
                                <th style="width: 35%;">الوصف</th>
                                <th style="width: 10%;">الوحدة</th>
                                <th style="width: 10%;">الكمية</th>
                                <th style="width: 15%;">سعر الوحدة</th>
                                <th style="width: 15%;">الإجمالي</th>
                                <th style="width: 10%;"></th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td>1</td>
                                <td><input type="text" placeholder="وصف البند"></td>
                                <td><input type="text" placeholder="قطعة" value="قطعة"></td>
                                <td><input type="number" placeholder="1" value="1" onchange="calculateRow(this)"></td>
                                <td><input type="number" placeholder="0.00" value="0" onchange="calculateRow(this)"></td>
                                <td><input type="number" placeholder="0.00" value="0" readonly></td>
                                <td><button class="section-btn" onclick="deleteRow(this)"><i class="fas fa-times"></i></button></td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="7">
                                    <button class="add-row-btn" onclick="addTableRow(this)">
                                        <i class="fas fa-plus"></i> إضافة بند جديد
                                    </button>
                                </td>
                            </tr>
                            <tr style="background: var(--gray-50);">
                                <td colspan="5" style="text-align: left; font-weight: 600;">المجموع الفرعي:</td>
                                <td colspan="2" style="font-weight: 600;">0.00 ر.س</td>
                            </tr>
                            <tr style="background: var(--gray-50);">
                                <td colspan="5" style="text-align: left; font-weight: 600;">ضريبة القيمة المضافة (15%):</td>
                                <td colspan="2" style="font-weight: 600;">0.00 ر.س</td>
                            </tr>
                            <tr style="background: linear-gradient(135deg, var(--gray-100), var(--gray-200));">
                                <td colspan="5" style="text-align: left; font-weight: 700; font-size: 18px;">الإجمالي النهائي:</td>
                                <td colspan="2" style="font-weight: 700; font-size: 18px; color: var(--primary);">0.00 ر.س</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
        }

        function createTermsComponent() {
            return `
                <div class="template-section" data-type="terms">
                    <div class="section-controls">
                        <button class="section-btn" onclick="moveUp(this)" title="نقل للأعلى">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="section-btn" onclick="moveDown(this)" title="نقل للأسفل">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button class="section-btn" onclick="editSection(this)" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="section-btn" onclick="deleteSection(this)" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <h3 style="margin-bottom: 18px; font-size: 20px;">الشروط والأحكام</h3>
                    <ol style="line-height: 2.2; color: var(--gray-600); font-size: 15px;" contenteditable="true">
                        <li>هذا العرض صالح لمدة 30 يوماً من تاريخ الإصدار.</li>
                        <li>شروط الدفع: 50% مقدماً، 50% عند الانتهاء من العمل.</li>
                        <li>جميع الأسعار بالريال السعودي وتشمل ضريبة القيمة المضافة 15%.</li>
                        <li>مدة التسليم: خلال 30 يوم عمل من تاريخ التأكيد.</li>
                        <li>الضمان: 12 شهر من تاريخ التسليم.</li>
                        <li>لا يشمل العرض أعمال إضافية خارج نطاق العمل المحدد.</li>
                        <li>يخضع هذا العقد للأنظمة واللوائح في المملكة العربية السعودية.</li>
                    </ol>
                </div>
            `;
        }

        function createSignatureComponent() {
            return `
                <div class="template-section" data-type="signature">
                    <div class="section-controls">
                        <button class="section-btn" onclick="moveUp(this)" title="نقل للأعلى">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="section-btn" onclick="moveDown(this)" title="نقل للأسفل">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button class="section-btn" onclick="editSection(this)" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="section-btn" onclick="deleteSection(this)" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 50px; margin-top: 50px;">
                        <div>
                            <div style="border-top: 2px solid var(--gray-300); padding-top: 10px;">
                                <strong style="font-size: 16px;">توقيع العميل</strong><br>
                                <span style="color: var(--gray-500); font-size: 14px;">الاسم والتاريخ</span>
                            </div>
                        </div>
                        <div>
                            <div style="border-top: 2px solid var(--gray-300); padding-top: 10px;">
                                <strong style="font-size: 16px;">ممثل الشركة</strong><br>
                                <span style="color: var(--gray-500); font-size: 14px;">الاسم والتاريخ</span>
                            </div>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--gray-200);">
                        <p style="color: var(--gray-500); font-size: 13px;">
                            <i class="fas fa-envelope"></i> info@company.sa | 
                            <i class="fas fa-phone"></i> 0500000000 | 
                            <i class="fas fa-globe"></i> www.company.sa
                        </p>
                    </div>
                </div>
            `;
        }

        function createTimelineComponent() {
            return `
                <div class="template-section" data-type="timeline">
                    <div class="section-controls">
                        <button class="section-btn" onclick="moveUp(this)" title="نقل للأعلى">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="section-btn" onclick="moveDown(this)" title="نقل للأسفل">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button class="section-btn" onclick="editSection(this)" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="section-btn" onclick="deleteSection(this)" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <h3 style="margin-bottom: 18px; font-size: 20px;">الجدول الزمني للمشروع</h3>
                    <div style="position: relative; padding-right: 35px;">
                        <div style="position: absolute; right: 10px; top: 0; bottom: 0; width: 3px; background: linear-gradient(180deg, var(--primary), var(--secondary));"></div>
                        <div style="margin-bottom: 25px;">
                            <div style="position: absolute; right: 6px; width: 11px; height: 11px; background: var(--primary); border-radius: 50%; box-shadow: 0 0 0 3px white, 0 0 0 6px rgba(30, 64, 175, 0.2);"></div>
                            <div contenteditable="true">
                                <strong style="font-size: 16px;">المرحلة الأولى: التخطيط والتصميم</strong><br>
                                <span style="color: var(--gray-500);">الأسبوع 1-2</span><br>
                                <span style="color: var(--gray-600); font-size: 14px;">إعداد المخططات والحصول على الموافقات</span>
                            </div>
                        </div>
                        <div style="margin-bottom: 25px;">
                            <div style="position: absolute; right: 6px; width: 11px; height: 11px; background: var(--primary); border-radius: 50%; box-shadow: 0 0 0 3px white, 0 0 0 6px rgba(30, 64, 175, 0.2);"></div>
                            <div contenteditable="true">
                                <strong style="font-size: 16px;">المرحلة الثانية: التنفيذ</strong><br>
                                <span style="color: var(--gray-500);">الأسبوع 3-8</span><br>
                                <span style="color: var(--gray-600); font-size: 14px;">تنفيذ الأعمال الأساسية والتشطيبات</span>
                            </div>
                        </div>
                        <div>
                            <div style="position: absolute; right: 6px; width: 11px; height: 11px; background: var(--primary); border-radius: 50%; box-shadow: 0 0 0 3px white, 0 0 0 6px rgba(30, 64, 175, 0.2);"></div>
                            <div contenteditable="true">
                                <strong style="font-size: 16px;">المرحلة الثالثة: التسليم والدعم</strong><br>
                                <span style="color: var(--gray-500);">الأسبوع 9-10</span><br>
                                <span style="color: var(--gray-600); font-size: 14px;">التسليم النهائي وفترة الضمان</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function createGalleryComponent() {
            return `
                <div class="template-section" data-type="gallery">
                    <div class="section-controls">
                        <button class="section-btn" onclick="moveUp(this)" title="نقل للأعلى">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="section-btn" onclick="moveDown(this)" title="نقل للأسفل">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button class="section-btn" onclick="editSection(this)" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="section-btn" onclick="deleteSection(this)" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <h3 style="margin-bottom: 18px; font-size: 20px;">نماذج من أعمالنا السابقة</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 18px;">
                        <div style="aspect-ratio: 1; background: linear-gradient(135deg, var(--gray-200), var(--gray-300)); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--gray-400); cursor: pointer;">
                            <i class="fas fa-image" style="font-size: 40px;"></i>
                        </div>
                        <div style="aspect-ratio: 1; background: linear-gradient(135deg, var(--gray-200), var(--gray-300)); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--gray-400); cursor: pointer;">
                            <i class="fas fa-image" style="font-size: 40px;"></i>
                        </div>
                        <div style="aspect-ratio: 1; background: linear-gradient(135deg, var(--gray-200), var(--gray-300)); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--gray-400); cursor: pointer;">
                            <i class="fas fa-image" style="font-size: 40px;"></i>
                        </div>
                    </div>
                </div>
            `;
        }

        function createPaymentComponent() {
            return `
                <div class="template-section" data-type="payment">
                    <div class="section-controls">
                        <button class="section-btn" onclick="moveUp(this)" title="نقل للأعلى">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="section-btn" onclick="moveDown(this)" title="نقل للأسفل">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button class="section-btn" onclick="editSection(this)" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="section-btn" onclick="deleteSection(this)" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <h3 style="margin-bottom: 18px; font-size: 20px;">جدول الدفعات</h3>
                    <table class="pricing-table">
                        <thead>
                            <tr>
                                <th>الدفعة</th>
                                <th>الوصف</th>
                                <th>النسبة</th>
                                <th>المبلغ</th>
                                <th>تاريخ الاستحقاق</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td contenteditable="true">الدفعة الأولى</td>
                                <td contenteditable="true">عند توقيع العقد</td>
                                <td contenteditable="true">30%</td>
                                <td contenteditable="true">يحسب تلقائياً</td>
                                <td contenteditable="true">فوري</td>
                            </tr>
                            <tr>
                                <td contenteditable="true">الدفعة الثانية</td>
                                <td contenteditable="true">منتصف المشروع</td>
                                <td contenteditable="true">40%</td>
                                <td contenteditable="true">يحسب تلقائياً</td>
                                <td contenteditable="true">بعد 30 يوم</td>
                            </tr>
                            <tr>
                                <td contenteditable="true">الدفعة النهائية</td>
                                <td contenteditable="true">عند التسليم</td>
                                <td contenteditable="true">30%</td>
                                <td contenteditable="true">يحسب تلقائياً</td>
                                <td contenteditable="true">عند الانتهاء</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        function createQRComponent() {
            return `
                <div class="template-section" data-type="qr">
                    <div class="section-controls">
                        <button class="section-btn" onclick="moveUp(this)" title="نقل للأعلى">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="section-btn" onclick="moveDown(this)" title="نقل للأسفل">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button class="section-btn" onclick="editSection(this)" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="section-btn" onclick="deleteSection(this)" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div style="text-align: center; padding: 30px;">
                        <h3 style="margin-bottom: 18px; font-size: 20px;">للدفع السريع</h3>
                        <div style="width: 200px; height: 200px; margin: 0 auto; background: linear-gradient(135deg, var(--gray-200), var(--gray-300)); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-qrcode" style="font-size: 100px; color: var(--gray-400);"></i>
                        </div>
                        <p style="margin-top: 18px; color: var(--gray-600); font-size: 14px;">
                            امسح الرمز للدفع عبر التطبيق البنكي
                        </p>
                    </div>
                </div>
            `;
        }

        function createDropZone(position) {
            return `
                <div class="drop-zone" data-position="${position}">
                    <div class="drop-zone-placeholder">
                        <i class="fas fa-plus-circle"></i>
                        <span>أضف مكوناً جديداً</span>
                    </div>
                </div>
            `;
        }

        // تهيئة محررات النص الغني
        function initializeEditors() {
            document.querySelectorAll('.text-editor').forEach(editor => {
                if (!editor.classList.contains('ql-container')) {
                    new Quill(editor, {
                        theme: 'snow',
                        modules: {
                            toolbar: [
                                ['bold', 'italic', 'underline', 'strike'],
                                ['blockquote', 'code-block'],
                                [{ 'header': 1 }, { 'header': 2 }],
                                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                [{ 'size': ['small', false, 'large', 'huge'] }],
                                [{ 'color': [] }, { 'background': [] }],
                                [{ 'font': [] }],
                                [{ 'align': [] }],
                                ['link'],
                                ['clean']
                            ]
                        }
                    });
                }
            });
        }

        // تحكمات الأقسام
        function moveUp(btn) {
            const section = btn.closest('.template-section');
            const prevElement = section.previousElementSibling;
            if (prevElement && prevElement.classList.contains('template-section')) {
                section.parentNode.insertBefore(section, prevElement);
                showNotification('تم نقل القسم للأعلى', 'success');
            }
        }

        function moveDown(btn) {
            const section = btn.closest('.template-section');
            const nextElement = section.nextElementSibling;
            if (nextElement && nextElement.classList.contains('template-section')) {
                section.parentNode.insertBefore(nextElement, section);
                showNotification('تم نقل القسم للأسفل', 'success');
            }
        }

        function editSection(btn) {
            const section = btn.closest('.template-section');
            // فتح لوحة الخصائص
            document.getElementById('propertiesPanel').classList.add('active');
            showNotification('قم بتعديل الخصائص من اللوحة الجانبية', 'info');
        }

        function deleteSection(btn) {
            if (confirm('هل أنت متأكد من حذف هذا القسم؟')) {
                const section = btn.closest('.template-section');
                section.remove();
                showNotification('تم حذف القسم بنجاح', 'success');
            }
        }

        // وظائف الجدول
        function addTableRow(btn) {
            const tbody = btn.closest('table').querySelector('tbody');
            const rowCount = tbody.querySelectorAll('tr').length;
            const newRow = tbody.insertRow(-1);
            newRow.innerHTML = `
                <td>${rowCount + 1}</td>
                <td><input type="text" placeholder="وصف البند"></td>
                <td><input type="text" placeholder="قطعة" value="قطعة"></td>
                <td><input type="number" placeholder="1" value="1" onchange="calculateRow(this)"></td>
                <td><input type="number" placeholder="0.00" value="0" onchange="calculateRow(this)"></td>
                <td><input type="number" placeholder="0.00" value="0" readonly></td>
                <td><button class="section-btn" onclick="deleteRow(this)"><i class="fas fa-times"></i></button></td>
            `;
            showNotification('تم إضافة بند جديد', 'success');
        }

        function deleteRow(btn) {
            const row = btn.closest('tr');
            row.remove();
            updateRowNumbers();
            calculateTotals();
        }

        function calculateRow(input) {
            const row = input.closest('tr');
            const quantity = parseFloat(row.cells[3].querySelector('input').value) || 0;
            const price = parseFloat(row.cells[4].querySelector('input').value) || 0;
            const total = quantity * price;
            row.cells[5].querySelector('input').value = total.toFixed(2);
            calculateTotals();
        }

        function calculateTotals() {
            const table = document.querySelector('.pricing-table');
            if (!table) return;
            
            let subtotal = 0;
            const rows = table.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                const totalCell = row.cells[5].querySelector('input');
                if (totalCell) {
                    subtotal += parseFloat(totalCell.value) || 0;
                }
            });
            
            const vat = subtotal * 0.15;
            const total = subtotal + vat;
            
            const tfoot = table.querySelector('tfoot');
            if (tfoot) {
                const footRows = tfoot.querySelectorAll('tr');
                if (footRows[1]) footRows[1].cells[1].textContent = `${subtotal.toFixed(2)} ر.س`;
                if (footRows[2]) footRows[2].cells[1].textContent = `${vat.toFixed(2)} ر.س`;
                if (footRows[3]) footRows[3].cells[1].textContent = `${total.toFixed(2)} ر.س`;
            }
        }

        function updateRowNumbers() {
            const tbody = document.querySelector('#tableBody');
            if (tbody) {
                const rows = tbody.querySelectorAll('tr');
                rows.forEach((row, index) => {
                    row.cells[0].textContent = index + 1;
                });
            }
        }

        // اختيارات الألوان
        function initializeColorPickers() {
            document.querySelectorAll('.color-picker').forEach(picker => {
                picker.addEventListener('change', (e) => {
                    const colorValue = e.target.parentElement.querySelector('.color-value');
                    colorValue.value = e.target.value;
                    applyTemplateSettings();
                });
            });

            document.querySelectorAll('.color-value').forEach(input => {
                input.addEventListener('change', (e) => {
                    const colorPicker = e.target.parentElement.querySelector('.color-picker');
                    colorPicker.value = e.target.value;
                    applyTemplateSettings();
                });
            });
        }

        function applyTemplateSettings() {
            const documentCanvas = document.getElementById('documentCanvas');
            const bgColor = document.getElementById('bgColor').value;
            const primaryColor = document.getElementById('primaryColor').value;
            
            documentCanvas.style.background = bgColor;
            document.documentElement.style.setProperty('--primary', primaryColor);
        }

        // إجراءات القالب
        function goBack() {
            if (confirm('هل أنت متأكد؟ قد تفقد التغييرات غير المحفوظة.')) {
                window.location.href = '/dashboard';
            }
        }

        function previewTemplate() {
            // فتح نافذة المعاينة
            const previewWindow = window.open('', 'معاينة', 'width=900,height=700');
            const content = document.getElementById('documentCanvas').innerHTML;
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <title>معاينة القالب</title>
                    <style>
                        body { font-family: 'Cairo', sans-serif; padding: 40px; direction: rtl; }
                        .drop-zone { display: none; }
                        .section-controls { display: none; }
                        * { font-family: 'Cairo', sans-serif; }
                    </style>
                </head>
                <body>${content}</body>
                </html>
            `);
        }

        function saveAsDraft() {
            showLoading();
            // حفظ القالب كمسودة
            setTimeout(() => {
                hideLoading();
                showNotification('تم حفظ القالب كمسودة بنجاح', 'success');
            }, 1500);
        }

        function publishTemplate() {
            showLoading();
            // نشر القالب
            setTimeout(() => {
                hideLoading();
                showNotification('تم نشر القالب بنجاح', 'success');
            }, 1500);
        }

        function uploadLogo() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    showNotification('تم رفع الشعار بنجاح', 'success');
                }
            };
            input.click();
        }

        // أدوات مساعدة
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        function showNotification(message, type = 'info') {
            // إنشاء عنصر الإشعار
            const notification = document.createElement('div');
            const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'times-circle' : 'info-circle';
            const bgColor = type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : 'var(--info)';
            
            notification.style.cssText = `
                position: fixed;
                bottom: 30px;
                left: 30px;
                padding: 16px 24px;
                background: ${bgColor};
                color: white;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
                z-index: 10000;
                animation: slideInUp 0.3s ease-out;
                display: flex;
                align-items: center;
                gap: 12px;
                font-weight: 600;
                font-family: 'Cairo', sans-serif;
            `;
            
            notification.innerHTML = `<i class="fas fa-${icon}"></i> ${message}`;
            document.body.appendChild(notification);

            // إزالة بعد 3 ثوان
            setTimeout(() => {
                notification.style.animation = 'slideOutDown 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // إضافة أنماط الحركة
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInUp {
                from {
                    transform: translateY(100%);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
            @keyframes slideOutDown {
                from {
                    transform: translateY(0);
                    opacity: 1;
                }
                to {
                    transform: translateY(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
